<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gantt Chart Pro</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

  /* ── Theme Variables ── */
  :root {
    --bg-primary: #0f1117;
    --bg-secondary: #1a1d27;
    --bg-tertiary: #242834;
    --bg-hover: #2a2e3a;
    --text-primary: #e8eaed;
    --text-secondary: #9aa0a6;
    --text-muted: #6b7280;
    --border-color: #2d3140;
    --accent-blue: #4f8ff7;
    --accent-green: #34d399;
    --accent-orange: #f59e0b;
    --accent-red: #ef4444;
    --accent-purple: #a78bfa;
    --accent-cyan: #22d3ee;
    --shadow: 0 4px 24px rgba(0,0,0,0.3);
    --header-bg: linear-gradient(135deg, #1e2333 0%, #171b28 100%);
    --file-group-bg: linear-gradient(135deg, #1c2030, #252a3a);
    --file-group-hover: linear-gradient(135deg, #222740, #2a3045);
    --scrollbar-track: #0f1117;
    --scrollbar-thumb: #242834;
    --scrollbar-hover: #3a3f50;
    --loading-overlay: rgba(15,17,23,0.85);
    --modal-bg: rgba(0,0,0,0.6);
    --stripe-color: rgba(255,255,255,0.08);
  }

  [data-theme="light"] {
    --bg-primary: #f5f6fa;
    --bg-secondary: #ffffff;
    --bg-tertiary: #ebedf3;
    --bg-hover: #e2e4ea;
    --text-primary: #1a1d27;
    --text-secondary: #5a6170;
    --text-muted: #8a8f9d;
    --border-color: #d1d5de;
    --shadow: 0 4px 24px rgba(0,0,0,0.08);
    --header-bg: linear-gradient(135deg, #e8eaf0 0%, #f0f1f6 100%);
    --file-group-bg: linear-gradient(135deg, #e8eaf0, #f0f1f6);
    --file-group-hover: linear-gradient(135deg, #dde0e8, #e8eaf0);
    --scrollbar-track: #f5f6fa;
    --scrollbar-thumb: #d1d5de;
    --scrollbar-hover: #b0b5c0;
    --loading-overlay: rgba(245,246,250,0.85);
    --modal-bg: rgba(0,0,0,0.3);
    --stripe-color: rgba(0,0,0,0.06);
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    overflow-x: hidden;
    min-height: 100vh;
    transition: background 0.3s ease, color 0.3s ease;
  }

  /* ── Upload Screen ── */
  #uploadScreen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 40px;
    transition: background 0.3s ease;
  }
  #uploadScreen h1 {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  #uploadScreen .subtitle {
    color: var(--text-secondary);
    font-size: 14px;
    margin-bottom: 36px;
    transition: color 0.3s ease;
  }

  .drop-zone {
    width: 560px;
    max-width: 90vw;
    border: 2px dashed var(--border-color);
    border-radius: 16px;
    padding: 48px 32px;
    text-align: center;
    cursor: pointer;
    transition: all 0.25s;
    background: var(--bg-secondary);
    position: relative;
  }
  .drop-zone:hover, .drop-zone.dragover {
    border-color: var(--accent-blue);
    background: rgba(79, 143, 247, 0.06);
  }
  .drop-zone.dragover { transform: scale(1.02); }
  .drop-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
  .drop-icon { font-size: 48px; margin-bottom: 16px; opacity: 0.6; }
  .drop-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
  .drop-hint { font-size: 13px; color: var(--text-muted); }

  /* ── File List ── */
  .file-list { width: 560px; max-width: 90vw; margin-top: 20px; }
  .file-item {
    display: flex; align-items: center; gap: 12px; padding: 10px 14px;
    background: var(--bg-tertiary); border: 1px solid var(--border-color);
    border-radius: 8px; margin-bottom: 8px; font-size: 13px;
    animation: fadeIn 0.2s ease; transition: background 0.3s ease, border-color 0.3s ease;
  }
  @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:none; } }
  @keyframes fadeInRow { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:none; } }
  .file-item .file-icon-small {
    width: 32px; height: 32px; border-radius: 6px;
    display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700; color: #fff; flex-shrink: 0;
  }
  .file-item .file-info { flex: 1; min-width: 0; }
  .file-item .file-name {
    font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  }
  .file-item .file-meta { font-size: 11px; color: var(--text-muted); }
  .file-item .file-remove {
    width: 24px; height: 24px; border-radius: 50%; border: none;
    background: transparent; color: var(--text-muted); cursor: pointer;
    font-size: 16px; display: flex; align-items: center; justify-content: center;
    transition: all 0.15s;
  }
  .file-item .file-remove:hover { background: var(--accent-red); color: #fff; }

  .generate-btn {
    margin-top: 24px; padding: 12px 40px; border-radius: 10px; border: none;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    color: #fff; font-size: 15px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; letter-spacing: 0.3px;
  }
  .generate-btn:hover { transform: translateY(-1px); box-shadow: 0 8px 24px rgba(79, 143, 247, 0.3); }
  .generate-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

  /* ── Gantt Screen ── */
  #ganttScreen { display: none; height: 100vh; flex-direction: column; }
  #ganttScreen.active { display: flex; }
  #uploadScreen.hidden { display: none; }

  /* ── Header ── */
  .header {
    background: var(--header-bg); padding: 16px 24px;
    border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; justify-content: space-between;
    flex-wrap: wrap; gap: 12px; flex-shrink: 0;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .back-btn {
    padding: 6px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--bg-tertiary); color: var(--text-primary); font-size: 13px;
    cursor: pointer; transition: all 0.2s; font-weight: 500;
  }
  .back-btn:hover { background: var(--accent-blue); border-color: var(--accent-blue); color: #fff; }
  .header h1 {
    font-size: 18px; font-weight: 700;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .header-stats { display: flex; gap: 16px; flex-wrap: wrap; align-items: center; }
  .stat-card {
    background: var(--bg-tertiary); padding: 6px 14px; border-radius: 8px;
    text-align: center; border: 1px solid var(--border-color);
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  .stat-card .num { font-size: 18px; font-weight: 700; color: var(--accent-blue); }
  .stat-card .label {
    font-size: 10px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;
  }
  .unsaved-badge {
    background: var(--accent-orange); color: #000; font-size: 11px; font-weight: 600;
    padding: 4px 10px; border-radius: 12px; animation: pulse 1.5s infinite;
    display: none;
  }
  .unsaved-badge.visible { display: inline-block; }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.7} }

  /* ── Controls ── */
  .controls {
    padding: 10px 24px; background: var(--bg-secondary);
    border-bottom: 1px solid var(--border-color);
    display: flex; gap: 10px; align-items: center; flex-wrap: wrap; flex-shrink: 0;
    transition: background 0.3s ease, border-color 0.3s ease;
  }
  .controls label { font-size: 12px; color: var(--text-secondary); font-weight: 500; }
  .controls select, .controls input[type="text"] {
    background: var(--bg-tertiary); border: 1px solid var(--border-color);
    color: var(--text-primary); padding: 5px 10px; border-radius: 6px;
    font-size: 12px; outline: none; transition: border-color 0.2s, background 0.3s;
  }
  .controls select:focus, .controls input[type="text"]:focus { border-color: var(--accent-blue); }
  .btn {
    padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--bg-tertiary); color: var(--text-primary); font-size: 12px;
    cursor: pointer; transition: all 0.2s; font-weight: 500; white-space: nowrap;
  }
  .btn:hover { background: var(--accent-blue); border-color: var(--accent-blue); color: #fff; }
  .btn.active { background: var(--accent-red); border-color: var(--accent-red); color: #fff; }
  .btn-export {
    background: linear-gradient(135deg, var(--accent-green), var(--accent-cyan));
    border-color: transparent; color: #000; font-weight: 600;
  }
  .btn-export:hover { opacity: 0.85; color: #000; }
  .btn-add {
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border-color: transparent; color: #fff; font-weight: 600; font-size: 14px;
    width: 28px; height: 28px; padding: 0; display: flex; align-items: center; justify-content: center;
    border-radius: 50%;
  }
  .btn-add:hover { transform: scale(1.1); color: #fff; }
  .theme-toggle {
    padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--bg-tertiary); color: var(--text-primary); font-size: 14px;
    cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 4px;
  }
  .theme-toggle:hover { border-color: var(--accent-blue); }

  /* ── Main Layout ── */
  .gantt-wrapper { display: flex; flex: 1; overflow: hidden; flex-direction: column; }
  .gantt-main { display: flex; flex: 1; overflow: hidden; }

  /* ── Task Panel ── */
  .task-panel {
    width: 380px; min-width: 260px; background: var(--bg-secondary);
    border-right: 2px solid var(--border-color);
    display: flex; flex-direction: column; overflow: hidden; flex-shrink: 0;
    position: relative; transition: background 0.3s ease, border-color 0.3s ease;
  }
  .task-panel-header {
    display: grid; grid-template-columns: 50px 1fr 70px 60px;
    padding: 8px 10px; background: var(--bg-tertiary);
    border-bottom: 1px solid var(--border-color);
    font-size: 10px; font-weight: 600; color: var(--text-secondary);
    text-transform: uppercase; letter-spacing: 0.5px;
    transition: background 0.3s ease;
  }
  .task-list { overflow-y: auto; flex: 1; }

  .file-group-header {
    padding: 8px 10px; background: var(--file-group-bg);
    font-size: 12px; font-weight: 700; cursor: pointer;
    display: flex; align-items: center; gap: 8px;
    border-bottom: 2px solid var(--border-color); user-select: none;
    transition: background 0.3s ease;
  }
  .file-group-header:hover { background: var(--file-group-hover); }
  .file-group-header .fg-icon {
    width: 18px; height: 18px; border-radius: 4px;
    display: flex; align-items: center; justify-content: center;
    font-size: 10px; font-weight: 700; color: #fff; flex-shrink: 0;
  }
  .file-group-header .fg-stats {
    margin-left: auto; font-size: 10px; font-weight: 400; color: var(--text-muted);
  }

  .cat-group-header {
    padding: 6px 10px 6px 28px; background: var(--bg-tertiary);
    font-size: 11px; font-weight: 600; cursor: pointer;
    display: flex; align-items: center; gap: 6px;
    border-bottom: 1px solid var(--border-color); user-select: none;
    transition: background 0.3s ease;
  }
  .cat-group-header:hover { background: var(--bg-hover); }

  .group-arrow { transition: transform 0.2s; font-size: 9px; flex-shrink: 0; }
  .group-arrow.collapsed { transform: rotate(-90deg); }

  .task-row {
    display: grid; grid-template-columns: 50px 1fr 70px 60px;
    padding: 6px 10px 6px 36px; border-bottom: 1px solid var(--border-color);
    align-items: center; font-size: 12px; transition: background 0.15s;
    cursor: default; animation: fadeInRow 0.25s ease;
  }
  .task-row:hover, .task-row.highlight { background: var(--bg-hover); }
  .task-id {
    color: var(--text-muted); font-size: 10px; font-family: monospace;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .task-name {
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    font-weight: 500; padding-right: 6px;
  }
  .task-owner {
    color: var(--text-secondary); font-size: 11px; text-align: center;
    display: flex; align-items: center; justify-content: center; gap: 2px;
  }
  .conflict-warn { cursor: help; font-size: 13px; }
  .task-progress-cell { text-align: center; }
  .mini-progress {
    width: 36px; height: 3px; background: var(--bg-primary);
    border-radius: 2px; overflow: hidden;
    display: inline-block; vertical-align: middle; margin-right: 2px;
  }
  .mini-progress-fill { height: 100%; border-radius: 2px; }

  /* ── Chart Panel ── */
  .chart-panel { flex: 1; overflow: auto; position: relative; }
  .chart-header {
    position: sticky; top: 0; z-index: 10;
    background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
    transition: background 0.3s ease;
  }
  .chart-header-months { display: flex; border-bottom: 1px solid var(--border-color); }
  .chart-header-months .month-cell {
    text-align: center; font-size: 11px; font-weight: 600;
    color: var(--text-primary); padding: 5px 0;
    border-right: 1px solid var(--border-color);
  }
  .chart-header-days { display: flex; }
  .chart-header-days .day-cell {
    text-align: center; font-size: 9px; color: var(--text-muted);
    border-right: 1px solid rgba(45,49,64,0.5); padding: 3px 0;
  }
  .day-cell.weekend { background: rgba(239,68,68,0.05); color: rgba(239,68,68,0.4); }
  .day-cell.today { background: rgba(79,143,247,0.15); color: var(--accent-blue); font-weight: 600; }
  .chart-body { position: relative; }
  .chart-row {
    position: relative; border-bottom: 1px solid var(--border-color); display: flex;
  }
  .chart-row:hover { background: var(--bg-hover); }
  .chart-row.file-header-row {
    background: var(--file-group-bg);
    border-bottom: 2px solid var(--border-color);
  }
  .chart-row.cat-header-row { background: var(--bg-tertiary); }
  .chart-cell { border-right: 1px solid rgba(45,49,64,0.3); flex-shrink: 0; }
  .chart-cell.weekend { background: rgba(239,68,68,0.03); }

  /* ── Gantt Bars ── */
  .gantt-bar-wrapper {
    position: absolute; top: 3px; height: calc(100% - 6px); z-index: 3; cursor: pointer;
  }
  .gantt-bar {
    height: 100%; border-radius: 4px; position: relative; overflow: hidden;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    transition: box-shadow 0.2s, transform 0.15s, filter 0.2s;
  }
  .gantt-bar:hover {
    box-shadow: 0 4px 14px rgba(0,0,0,0.4), 0 0 12px rgba(79,143,247,0.3);
    transform: scaleY(1.12);
    filter: brightness(1.1);
  }
  .gantt-bar-bg { position: absolute; inset: 0; opacity: 0.25; border-radius: 4px; }
  .gantt-bar-progress {
    position: absolute; left: 0; top: 0; bottom: 0; border-radius: 4px; opacity: 0.85;
  }
  /* Stripe pattern for in-progress tasks */
  .gantt-bar-progress.in-progress {
    background-image: repeating-linear-gradient(
      45deg,
      transparent, transparent 4px,
      var(--stripe-color) 4px, var(--stripe-color) 8px
    ) !important;
    background-size: auto;
  }
  .gantt-bar-text {
    position: relative; z-index: 1; padding: 0 6px; font-size: 10px; font-weight: 500;
    color: #fff; line-height: 26px; white-space: nowrap; overflow: hidden;
    text-overflow: ellipsis; text-shadow: 0 1px 2px rgba(0,0,0,0.3);
  }

  /* ── Milestone Diamond ── */
  .gantt-milestone {
    position: absolute; top: 50%; z-index: 4; cursor: pointer;
    width: 16px; height: 16px; transform: translate(-50%, -50%) rotate(45deg);
    border-radius: 2px; box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: transform 0.2s, box-shadow 0.2s;
  }
  .gantt-milestone:hover {
    transform: translate(-50%, -50%) rotate(45deg) scale(1.3);
    box-shadow: 0 4px 14px rgba(0,0,0,0.5), 0 0 12px rgba(79,143,247,0.3);
  }

  /* ── Critical path ── */
  .gantt-bar.critical-path .gantt-bar-bg { background: var(--accent-red) !important; opacity: 0.4; }
  .gantt-bar.critical-path .gantt-bar-progress { background: var(--accent-red) !important; }
  .gantt-bar.critical-path { box-shadow: 0 0 8px rgba(239,68,68,0.5); }
  .gantt-milestone.critical-path { background: var(--accent-red) !important; box-shadow: 0 0 8px rgba(239,68,68,0.5); }

  /* ── Bar resize handles ── */
  .bar-resize-handle {
    position: absolute; top: 0; width: 8px; height: 100%;
    cursor: ew-resize; z-index: 5;
  }
  .bar-resize-handle.left { left: -2px; }
  .bar-resize-handle.right { right: -2px; }
  .bar-resize-handle:hover { background: rgba(79,143,247,0.3); border-radius: 2px; }

  /* ── Drag date tooltip ── */
  .drag-date-tip {
    position: fixed; background: var(--bg-tertiary); border: 1px solid var(--accent-blue);
    color: var(--text-primary); font-size: 11px; padding: 3px 8px; border-radius: 4px;
    pointer-events: none; z-index: 2000; white-space: nowrap;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    display: none;
  }
  .drag-date-tip.visible { display: block; }

  /* ── Dependencies ── */
  .dependency-svg { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 2; }
  .dep-line { fill: none; stroke: var(--accent-orange); stroke-width: 1.5; opacity: 0.5; stroke-dasharray: 4 2; }
  .dep-arrow { fill: var(--accent-orange); opacity: 0.5; }

  /* ── Today Line ── */
  .today-line {
    position: absolute; top: 0; bottom: 0; width: 2px;
    background: var(--accent-red); z-index: 5; pointer-events: none;
  }
  .today-line::before {
    content: 'TODAY'; position: absolute; top: -18px; left: -16px;
    font-size: 8px; font-weight: 700; color: var(--accent-red); letter-spacing: 0.5px;
  }

  /* ── Tooltip ── */
  .tooltip {
    position: fixed; background: var(--bg-tertiary); border: 1px solid var(--border-color);
    border-radius: 10px; padding: 12px 16px; font-size: 12px; z-index: 1000;
    pointer-events: none; opacity: 0; transition: opacity 0.15s, background 0.3s;
    box-shadow: var(--shadow); max-width: 320px;
  }
  .tooltip.visible { opacity: 1; }
  .tooltip .tt-source {
    font-size: 10px; color: var(--text-muted); margin-bottom: 4px;
    padding: 1px 6px; background: var(--bg-primary); border-radius: 3px; display: inline-block;
  }
  .tooltip .tt-title { font-weight: 700; font-size: 13px; margin-bottom: 6px; }
  .tooltip .tt-row { display: flex; justify-content: space-between; padding: 2px 0; gap: 14px; }
  .tooltip .tt-label { color: var(--text-secondary); white-space: nowrap; }
  .tooltip .tt-value { font-weight: 500; text-align: right; }
  .tooltip .tt-progress-bar {
    width: 100%; height: 5px; background: var(--bg-primary);
    border-radius: 3px; margin-top: 6px; overflow: hidden;
  }
  .tooltip .tt-progress-fill { height: 100%; border-radius: 3px; }

  .resize-handle {
    position: absolute; right: 0; top: 0; width: 4px; height: 100%;
    cursor: col-resize; z-index: 20; background: transparent;
  }
  .resize-handle:hover { background: var(--accent-blue); }

  ::-webkit-scrollbar { width: 7px; height: 7px; }
  ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
  ::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }
  ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

  /* ── Loading ── */
  .loading-overlay {
    position: fixed; inset: 0; background: var(--loading-overlay);
    display: none; align-items: center; justify-content: center;
    z-index: 9999; flex-direction: column; gap: 16px;
  }
  .loading-overlay.active { display: flex; }
  .spinner {
    width: 40px; height: 40px; border: 3px solid var(--border-color);
    border-top-color: var(--accent-blue); border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { font-size: 14px; color: var(--text-secondary); }

  /* ── Heatmap Panel ── */
  .heatmap-panel {
    background: var(--bg-secondary); border-top: 2px solid var(--border-color);
    overflow: auto; max-height: 0; transition: max-height 0.4s ease, padding 0.3s ease;
    padding: 0 24px;
  }
  .heatmap-panel.open { max-height: 300px; padding: 16px 24px; }
  .heatmap-title {
    font-size: 13px; font-weight: 700; margin-bottom: 10px;
    color: var(--text-primary); display: flex; align-items: center; gap: 8px;
  }
  .heatmap-grid { display: flex; flex-direction: column; gap: 6px; }
  .heatmap-row { display: flex; align-items: center; gap: 6px; }
  .heatmap-label {
    width: 80px; font-size: 11px; color: var(--text-secondary);
    text-align: right; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-shrink: 0;
  }
  .heatmap-cells { display: flex; gap: 2px; flex: 1; overflow-x: auto; }
  .heatmap-cell {
    min-width: 28px; height: 20px; border-radius: 3px;
    display: flex; align-items: center; justify-content: center;
    font-size: 9px; color: #fff; font-weight: 600;
    transition: transform 0.15s;
  }
  .heatmap-cell:hover { transform: scale(1.2); z-index: 1; }
  .heatmap-week-labels { display: flex; gap: 2px; margin-left: 86px; margin-bottom: 4px; }
  .heatmap-week-label { min-width: 28px; font-size: 8px; color: var(--text-muted); text-align: center; }

  /* ── Modal ── */
  .modal-overlay {
    position: fixed; inset: 0; background: var(--modal-bg);
    display: none; align-items: center; justify-content: center; z-index: 5000;
  }
  .modal-overlay.active { display: flex; }
  .modal {
    background: var(--bg-secondary); border: 1px solid var(--border-color);
    border-radius: 12px; padding: 24px; min-width: 400px; max-width: 90vw;
    box-shadow: var(--shadow); transition: background 0.3s ease;
  }
  .modal h3 {
    font-size: 16px; font-weight: 700; margin-bottom: 16px;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .modal-field { margin-bottom: 12px; }
  .modal-field label {
    display: block; font-size: 12px; font-weight: 600;
    color: var(--text-secondary); margin-bottom: 4px;
  }
  .modal-field input, .modal-field select {
    width: 100%; padding: 8px 10px; border-radius: 6px;
    border: 1px solid var(--border-color); background: var(--bg-tertiary);
    color: var(--text-primary); font-size: 13px; outline: none;
    transition: border-color 0.2s;
  }
  .modal-field input:focus, .modal-field select:focus { border-color: var(--accent-blue); }
  .modal-field input[type="range"] {
    -webkit-appearance: auto; appearance: auto; padding: 0;
    background: transparent; border: none;
  }
  .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 18px; }
  .modal-actions .btn { padding: 8px 20px; }
  .modal-actions .btn-primary {
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    border-color: transparent; color: #fff;
  }

  /* ── Context Menu ── */
  .context-menu {
    position: fixed; background: var(--bg-tertiary); border: 1px solid var(--border-color);
    border-radius: 8px; padding: 4px; z-index: 6000; min-width: 140px;
    box-shadow: var(--shadow); display: none;
  }
  .context-menu.active { display: block; }
  .context-menu-item {
    padding: 8px 12px; font-size: 12px; cursor: pointer; border-radius: 4px;
    display: flex; align-items: center; gap: 8px;
    transition: background 0.15s; color: var(--text-primary);
  }
  .context-menu-item:hover { background: var(--bg-hover); }
  .context-menu-item.danger { color: var(--accent-red); }
  .context-menu-item.danger:hover { background: rgba(239,68,68,0.15); }

  /* ── Inline Edit Row ── */
  .inline-edit-form {
    display: grid; grid-template-columns: 50px 1fr 70px 60px;
    padding: 8px 10px 8px 36px; border-bottom: 1px solid var(--accent-blue);
    align-items: start; font-size: 12px; background: var(--bg-hover);
    border-left: 3px solid var(--accent-blue);
  }
  .inline-edit-form .ie-fields { display: flex; flex-direction: column; gap: 4px; }
  .inline-edit-form input {
    width: 100%; padding: 3px 6px; border-radius: 4px;
    border: 1px solid var(--border-color); background: var(--bg-tertiary);
    color: var(--text-primary); font-size: 11px; outline: none;
  }
  .inline-edit-form input:focus { border-color: var(--accent-blue); }
  .inline-edit-form .ie-actions { display: flex; gap: 4px; flex-direction: column; align-items: center; }
  .inline-edit-form .ie-actions button {
    padding: 2px 8px; border-radius: 4px; border: none; font-size: 10px;
    cursor: pointer; font-weight: 600;
  }
  .ie-save { background: var(--accent-green); color: #000; }
  .ie-cancel { background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color) !important; }

  /* upload theme toggle */
  .upload-theme-toggle {
    position: fixed; top: 16px; right: 16px; z-index: 100;
  }

  /* ── Tab Switcher ── */
  .input-tabs {
    display: flex; gap: 0; margin-bottom: 24px; width: 560px; max-width: 90vw;
    background: var(--bg-tertiary); border-radius: 10px; overflow: hidden;
    border: 1px solid var(--border-color);
  }
  .input-tab {
    flex: 1; padding: 12px 16px; text-align: center; cursor: pointer;
    font-size: 14px; font-weight: 600; color: var(--text-secondary);
    transition: all 0.2s; border: none; background: transparent;
    position: relative;
  }
  .input-tab:hover { color: var(--text-primary); background: var(--bg-hover); }
  .input-tab.active {
    color: #fff;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
  }
  .input-tab .tab-icon { margin-right: 6px; font-size: 15px; }

  /* ── Text Parse Panel ── */
  .text-parse-panel {
    width: 560px; max-width: 90vw; display: none;
  }
  .text-parse-panel.active { display: block; }
  .text-area-wrap {
    position: relative; border-radius: 12px; overflow: hidden;
    border: 2px solid var(--border-color); transition: border-color 0.2s;
    background: var(--bg-secondary);
  }
  .text-area-wrap:focus-within { border-color: var(--accent-blue); }
  .text-area-wrap textarea {
    width: 100%; min-height: 220px; padding: 16px; border: none; resize: vertical;
    background: transparent; color: var(--text-primary); font-size: 13px;
    font-family: 'Inter', monospace; line-height: 1.6; outline: none;
  }
  .text-area-wrap textarea::placeholder { color: var(--text-muted); }
  .text-area-toolbar {
    display: flex; align-items: center; gap: 8px; padding: 8px 12px;
    background: var(--bg-tertiary); border-top: 1px solid var(--border-color);
    flex-wrap: wrap;
  }
  .text-area-toolbar .hint {
    font-size: 11px; color: var(--text-muted); flex: 1;
  }
  .format-tag {
    font-size: 10px; padding: 3px 8px; border-radius: 4px;
    background: var(--bg-primary); color: var(--text-secondary);
    border: 1px solid var(--border-color); cursor: pointer;
    transition: all 0.15s;
  }
  .format-tag:hover { border-color: var(--accent-blue); color: var(--accent-blue); }
  .format-tag.detected {
    background: rgba(79,143,247,0.15); border-color: var(--accent-blue);
    color: var(--accent-blue); font-weight: 600;
  }
  .parse-status {
    margin-top: 12px; padding: 10px 14px; border-radius: 8px;
    font-size: 12px; display: none; align-items: center; gap: 8px;
    animation: fadeIn 0.2s ease;
  }
  .parse-status.active { display: flex; }
  .parse-status.success {
    background: rgba(52,211,153,0.1); border: 1px solid rgba(52,211,153,0.3);
    color: var(--accent-green);
  }
  .parse-status.error {
    background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3);
    color: var(--accent-red);
  }
  .parse-status .status-icon { font-size: 16px; }
  .template-examples {
    margin-top: 14px; display: flex; gap: 8px; flex-wrap: wrap;
  }
  .template-btn {
    padding: 6px 12px; border-radius: 6px; font-size: 11px; cursor: pointer;
    border: 1px solid var(--border-color); background: var(--bg-tertiary);
    color: var(--text-secondary); transition: all 0.15s; font-weight: 500;
  }
  .template-btn:hover { border-color: var(--accent-blue); color: var(--accent-blue); }

  /* ── Data Preview Modal ── */
  .preview-overlay {
    position: fixed; inset: 0; background: var(--modal-bg);
    display: none; align-items: center; justify-content: center; z-index: 5500;
  }
  .preview-overlay.active { display: flex; }
  .preview-modal {
    background: var(--bg-secondary); border: 1px solid var(--border-color);
    border-radius: 14px; width: 90vw; max-width: 960px; max-height: 85vh;
    display: flex; flex-direction: column; box-shadow: var(--shadow);
    overflow: hidden;
  }
  .preview-header {
    padding: 18px 24px; border-bottom: 1px solid var(--border-color);
    display: flex; align-items: center; gap: 14px;
    background: var(--header-bg);
  }
  .preview-header h3 {
    font-size: 16px; font-weight: 700; margin: 0;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .preview-header .preview-stats {
    margin-left: auto; display: flex; gap: 10px;
  }
  .preview-stat {
    font-size: 12px; color: var(--text-secondary);
    padding: 4px 10px; background: var(--bg-tertiary);
    border-radius: 6px; border: 1px solid var(--border-color);
  }
  .preview-stat strong { color: var(--accent-blue); }
  .preview-body {
    flex: 1; overflow: auto; padding: 0;
  }

  /* Field mapping bar */
  .field-mapping-bar {
    display: flex; gap: 6px; padding: 12px 24px; flex-wrap: wrap;
    background: var(--bg-tertiary); border-bottom: 1px solid var(--border-color);
    align-items: center;
  }
  .field-mapping-bar label {
    font-size: 11px; color: var(--text-muted); font-weight: 600;
    text-transform: uppercase; letter-spacing: 0.5px;
  }
  .field-chip {
    display: inline-flex; align-items: center; gap: 4px;
    padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600;
    border: 1px solid var(--border-color); background: var(--bg-secondary);
    color: var(--text-primary);
  }
  .field-chip .chip-dot {
    width: 6px; height: 6px; border-radius: 50%;
  }
  .field-chip.mapped { border-color: var(--accent-green); }
  .field-chip.mapped .chip-dot { background: var(--accent-green); }
  .field-chip.unmapped { border-color: var(--accent-orange); opacity: 0.7; }
  .field-chip.unmapped .chip-dot { background: var(--accent-orange); }

  /* Preview table */
  .preview-table-wrap {
    overflow: auto; padding: 16px 24px;
  }
  .preview-table {
    width: 100%; border-collapse: collapse; font-size: 12px;
  }
  .preview-table th {
    padding: 8px 12px; text-align: left; font-weight: 600; font-size: 11px;
    color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.3px;
    background: var(--bg-tertiary); border-bottom: 2px solid var(--border-color);
    position: sticky; top: 0; z-index: 1;
  }
  .preview-table th select {
    display: block; margin-top: 4px; width: 100%;
    padding: 3px 6px; border-radius: 4px; font-size: 10px;
    background: var(--bg-secondary); border: 1px solid var(--border-color);
    color: var(--text-primary); outline: none;
  }
  .preview-table td {
    padding: 7px 12px; border-bottom: 1px solid var(--border-color);
    color: var(--text-primary); max-width: 200px;
    overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }
  .preview-table tr:hover td { background: var(--bg-hover); }
  .preview-table .row-checkbox {
    width: 16px; height: 16px; cursor: pointer; accent-color: var(--accent-blue);
  }
  .preview-table .cell-editable {
    cursor: text; border-radius: 3px; transition: background 0.15s;
    padding: 4px 6px;
  }
  .preview-table .cell-editable:hover { background: var(--bg-hover); }
  .preview-table .cell-editable:focus {
    outline: 2px solid var(--accent-blue); outline-offset: -1px;
    background: var(--bg-tertiary);
  }
  .preview-table .cell-error {
    color: var(--accent-red); font-style: italic;
  }
  .preview-table .cell-ok { color: var(--accent-green); }

  .preview-footer {
    padding: 14px 24px; border-top: 1px solid var(--border-color);
    display: flex; align-items: center; gap: 12px;
    background: var(--bg-tertiary);
  }
  .preview-footer .preview-info {
    flex: 1; font-size: 12px; color: var(--text-secondary);
  }
  .preview-footer .btn { padding: 8px 24px; font-size: 13px; }

  /* ── Agent Workflow Step Indicators ── */
  .workflow-steps {
    display: flex; align-items: center; gap: 0; margin-bottom: 28px;
    width: 560px; max-width: 90vw;
  }
  .wf-step {
    display: flex; align-items: center; gap: 8px;
    font-size: 12px; color: var(--text-muted); font-weight: 500;
    transition: color 0.2s;
  }
  .wf-step.active { color: var(--accent-blue); }
  .wf-step.done { color: var(--accent-green); }
  .wf-step-num {
    width: 26px; height: 26px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700;
    background: var(--bg-tertiary); border: 2px solid var(--border-color);
    transition: all 0.2s;
  }
  .wf-step.active .wf-step-num {
    background: var(--accent-blue); border-color: var(--accent-blue); color: #fff;
  }
  .wf-step.done .wf-step-num {
    background: var(--accent-green); border-color: var(--accent-green); color: #fff;
  }
  .wf-connector {
    flex: 1; height: 2px; background: var(--border-color); margin: 0 10px;
    transition: background 0.2s;
  }
  .wf-connector.done { background: var(--accent-green); }

  /* ── URL Fetch Panel ── */
  .url-fetch-panel {
    width: 560px; max-width: 90vw; display: none;
  }
  .url-fetch-panel.active { display: block; }
  .url-input-group {
    display: flex; gap: 8px; margin-bottom: 12px;
  }
  .url-input-group input {
    flex: 1; padding: 12px 14px; border-radius: 10px;
    border: 2px solid var(--border-color); background: var(--bg-secondary);
    color: var(--text-primary); font-size: 13px; outline: none;
    transition: border-color 0.2s;
  }
  .url-input-group input:focus { border-color: var(--accent-blue); }
  .url-input-group input::placeholder { color: var(--text-muted); }
  .url-fetch-btn {
    padding: 10px 20px; border-radius: 10px; border: none;
    background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
    color: #fff; font-size: 13px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
    display: flex; align-items: center; gap: 6px;
  }
  .url-fetch-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(79,143,247,0.3); }
  .url-fetch-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
  .url-fetch-btn .fetch-spinner {
    width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3);
    border-top-color: #fff; border-radius: 50%; animation: spin 0.6s linear infinite;
    display: none;
  }
  .url-fetch-btn.loading .fetch-spinner { display: inline-block; }
  .url-fetch-btn.loading .fetch-label { display: none; }

  .url-hint {
    font-size: 11px; color: var(--text-muted); margin-bottom: 14px; line-height: 1.5;
  }
  .url-history {
    display: flex; flex-direction: column; gap: 6px; margin-top: 10px;
  }
  .url-history-item {
    display: flex; align-items: center; gap: 10px; padding: 8px 12px;
    background: var(--bg-tertiary); border: 1px solid var(--border-color);
    border-radius: 8px; font-size: 12px; cursor: pointer;
    transition: all 0.15s; animation: fadeIn 0.2s ease;
  }
  .url-history-item:hover { background: var(--bg-hover); border-color: var(--accent-blue); }
  .url-history-item .url-status-dot {
    width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
  }
  .url-history-item .url-status-dot.ok { background: var(--accent-green); }
  .url-history-item .url-status-dot.err { background: var(--accent-red); }
  .url-history-item .url-status-dot.loading { background: var(--accent-orange); animation: pulse 1s infinite; }
  .url-history-item .url-text {
    flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    color: var(--text-primary);
  }
  .url-history-item .url-count {
    font-size: 11px; color: var(--accent-blue); font-weight: 600;
    background: rgba(79,143,247,0.1); padding: 2px 8px; border-radius: 4px;
  }
  .url-history-item .url-remove {
    width: 20px; height: 20px; border-radius: 50%; border: none;
    background: transparent; color: var(--text-muted); cursor: pointer;
    font-size: 14px; display: flex; align-items: center; justify-content: center;
  }
  .url-history-item .url-remove:hover { background: var(--accent-red); color: #fff; }

  .fetch-result-box {
    margin-top: 14px; padding: 12px 14px; border-radius: 10px;
    border: 1px solid var(--border-color); background: var(--bg-secondary);
    display: none; animation: fadeIn 0.2s ease;
  }
  .fetch-result-box.active { display: block; }
  .fetch-result-box .result-header {
    display: flex; align-items: center; gap: 8px; margin-bottom: 10px;
    font-size: 13px; font-weight: 600;
  }
  .fetch-result-box .result-header .result-icon { font-size: 16px; }
  .fetch-result-box .result-tables {
    display: flex; flex-direction: column; gap: 6px;
  }
  .fetch-table-option {
    display: flex; align-items: center; gap: 10px; padding: 8px 12px;
    border-radius: 6px; border: 1px solid var(--border-color);
    background: var(--bg-tertiary); cursor: pointer; transition: all 0.15s;
    font-size: 12px;
  }
  .fetch-table-option:hover { border-color: var(--accent-blue); background: var(--bg-hover); }
  .fetch-table-option.selected { border-color: var(--accent-green); background: rgba(52,211,153,0.08); }
  .fetch-table-option input[type="radio"] { accent-color: var(--accent-blue); }
  .fetch-table-option .table-info { flex: 1; }
  .fetch-table-option .table-info .table-name { font-weight: 600; }
  .fetch-table-option .table-info .table-detail { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
</style>
</head>
<body>

<!-- Upload Screen -->
<div id="uploadScreen">
  <div class="upload-theme-toggle">
    <button class="theme-toggle" onclick="toggleTheme()">
      <span id="themeIconUpload">&#9790;</span>
    </button>
  </div>
  <h1>Gantt Chart Pro</h1>
  <p class="subtitle">Agent 工作流 — 智能解析数据，自动生成交互式甘特图</p>

  <!-- Workflow Steps -->
  <div class="workflow-steps" id="workflowSteps">
    <div class="wf-step active" id="wfStep1">
      <div class="wf-step-num">1</div>
      <span>输入数据</span>
    </div>
    <div class="wf-connector" id="wfConn1"></div>
    <div class="wf-step" id="wfStep2">
      <div class="wf-step-num">2</div>
      <span>预览确认</span>
    </div>
    <div class="wf-connector" id="wfConn2"></div>
    <div class="wf-step" id="wfStep3">
      <div class="wf-step-num">3</div>
      <span>生成甘特图</span>
    </div>
  </div>

  <!-- Input Mode Tabs -->
  <div class="input-tabs">
    <button class="input-tab active" onclick="switchInputTab('file')" id="tabFile">
      <span class="tab-icon">&#128196;</span>文件上传
    </button>
    <button class="input-tab" onclick="switchInputTab('url')" id="tabUrl">
      <span class="tab-icon">&#127760;</span>URL 抓取
    </button>
    <button class="input-tab" onclick="switchInputTab('text')" id="tabText">
      <span class="tab-icon">&#9997;</span>智能解析
    </button>
  </div>

  <!-- File Upload Panel -->
  <div id="fileUploadPanel">
    <div class="drop-zone" id="dropZone">
      <input type="file" id="fileInput" multiple accept=".xlsx,.xls,.csv,.tsv">
      <div class="drop-icon">&#128203;</div>
      <div class="drop-title">拖拽文件到此处，或点击选择</div>
      <div class="drop-hint">支持 .xlsx / .csv / .tsv，可同时上传多个文件</div>
    </div>
    <div class="file-list" id="fileList"></div>
  </div>

  <!-- URL Fetch Panel -->
  <div class="url-fetch-panel" id="urlFetchPanel">
    <div class="url-input-group">
      <input type="text" id="urlInput" placeholder="输入网页地址，例如 https://example.com/tasks"
             onkeydown="if(event.key==='Enter')fetchUrl()">
      <button class="url-fetch-btn" id="urlFetchBtn" onclick="fetchUrl()">
        <div class="fetch-spinner"></div>
        <span class="fetch-label">抓取</span>
      </button>
    </div>
    <div class="url-hint">
      支持抓取任意网页中的表格数据。系统会自动识别页面中的 &lt;table&gt; 元素并提取任务信息。<br>
      适用于：项目管理页面、在线表格、Wiki 页面、报表页面等。
    </div>
    <div class="url-history" id="urlHistory"></div>
    <div class="fetch-result-box" id="fetchResultBox">
      <div class="result-header">
        <span class="result-icon">&#128203;</span>
        <span class="result-title">发现的表格</span>
      </div>
      <div class="result-tables" id="fetchResultTables"></div>
    </div>
  </div>

  <!-- Text Parse Panel -->
  <div class="text-parse-panel" id="textParsePanel">
    <div class="text-area-wrap">
      <textarea id="textInput" placeholder="粘贴任务数据到此处...&#10;&#10;支持的格式：&#10;• 表格文本（从 Excel/网页/飞书/Notion 直接粘贴）&#10;• CSV / TSV 格式&#10;• JSON 数组&#10;• 每行一条任务的自由文本&#10;&#10;示例：&#10;任务名称  负责人  开始日期    结束日期    进度&#10;需求分析  张三    2025-03-01  2025-03-15  80%&#10;UI设计    李四    2025-03-10  2025-03-25  40%"></textarea>
      <div class="text-area-toolbar">
        <span class="hint">自动检测格式：</span>
        <span class="format-tag" id="fmtTable">表格</span>
        <span class="format-tag" id="fmtCSV">CSV</span>
        <span class="format-tag" id="fmtJSON">JSON</span>
        <span class="format-tag" id="fmtFree">自由文本</span>
      </div>
    </div>
    <div class="parse-status" id="parseStatus">
      <span class="status-icon"></span>
      <span class="status-msg"></span>
    </div>
    <div class="template-examples">
      <span style="font-size:11px;color:var(--text-muted);margin-right:4px;">快速填充：</span>
      <button class="template-btn" onclick="fillTemplate('table')">表格示例</button>
      <button class="template-btn" onclick="fillTemplate('csv')">CSV 示例</button>
      <button class="template-btn" onclick="fillTemplate('json')">JSON 示例</button>
      <button class="template-btn" onclick="fillTemplate('free')">自由文本</button>
    </div>
  </div>

  <button class="generate-btn" id="generateBtn" disabled onclick="startPreview()">下一步：预览数据</button>
</div>

<!-- Data Preview Overlay -->
<div class="preview-overlay" id="previewOverlay">
  <div class="preview-modal">
    <div class="preview-header">
      <h3>&#128269; 数据预览与确认</h3>
      <div class="preview-stats" id="previewStats"></div>
    </div>
    <div class="field-mapping-bar" id="fieldMappingBar">
      <label>字段映射：</label>
    </div>
    <div class="preview-body">
      <div class="preview-table-wrap">
        <table class="preview-table" id="previewTable">
          <thead id="previewTHead"></thead>
          <tbody id="previewTBody"></tbody>
        </table>
      </div>
    </div>
    <div class="preview-footer">
      <div class="preview-info" id="previewInfo">
        选中 <strong id="previewSelectedCount">0</strong> 条任务
        · 双击单元格可编辑
      </div>
      <button class="btn" onclick="closePreview()">返回修改</button>
      <button class="btn btn-primary" style="background:linear-gradient(135deg,var(--accent-blue),var(--accent-purple));border-color:transparent;color:#fff;" onclick="confirmAndGenerate()">确认生成甘特图</button>
    </div>
  </div>
</div>

<!-- Gantt Screen -->
<div id="ganttScreen">
  <div class="header">
    <div class="header-left">
      <button class="back-btn" onclick="goBack()">&#8592; 返回上传</button>
      <h1 id="chartTitle">甘特图</h1>
      <span class="unsaved-badge" id="unsavedBadge">* 未保存修改</span>
    </div>
    <div class="header-stats" id="headerStats"></div>
  </div>
  <div class="controls">
    <label>来源</label>
    <select id="filterSource"><option value="">全部文件</option></select>
    <label>分类</label>
    <select id="filterCategory"><option value="">全部</option></select>
    <label>负责人</label>
    <select id="filterOwner"><option value="">全部</option></select>
    <label>搜索</label>
    <input type="text" id="searchInput" placeholder="任务名称..." style="width:120px">
    <div style="margin-left:auto; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
      <button class="btn btn-add" onclick="openAddTaskModal()" title="添加任务">+</button>
      <button class="btn" id="criticalPathBtn" onclick="toggleCriticalPath()">关键路径</button>
      <button class="btn" id="heatmapBtn" onclick="toggleHeatmap()">资源热力图</button>
      <button class="btn" onclick="collapseAll()">折叠</button>
      <button class="btn" onclick="expandAll()">展开</button>
      <button class="btn" onclick="zoomIn()">+</button>
      <button class="btn" onclick="zoomOut()">-</button>
      <button class="btn" onclick="fitAll()">适配</button>
      <button class="btn" onclick="scrollToToday()">今天</button>
      <button class="btn btn-export" onclick="exportPNG()">导出 PNG</button>
      <button class="btn btn-export" onclick="exportPDF()">导出 PDF</button>
      <button class="btn btn-export" id="exportExcelBtn" onclick="exportExcel()" style="display:none">导出 Excel</button>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="themeIconGantt">&#9790;</span>
      </button>
    </div>
  </div>
  <div class="gantt-wrapper">
    <div class="gantt-main">
      <div class="task-panel" id="taskPanel">
        <div class="resize-handle" id="resizeHandle"></div>
        <div class="task-panel-header">
          <div>ID</div><div>任务名称</div>
          <div style="text-align:center">负责人</div>
          <div style="text-align:center">进度</div>
        </div>
        <div class="task-list" id="taskList"></div>
      </div>
      <div class="chart-panel" id="chartPanel">
        <div class="chart-header" id="chartHeader"></div>
        <div class="chart-body" id="chartBody"></div>
      </div>
    </div>
    <div class="heatmap-panel" id="heatmapPanel"></div>
  </div>
</div>

<div class="tooltip" id="tooltip"></div>
<div class="drag-date-tip" id="dragDateTip"></div>
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">正在解析文件...</div>
</div>

<!-- Add/Edit Task Modal -->
<div class="modal-overlay" id="taskModal">
  <div class="modal">
    <h3 id="modalTitle">添加任务</h3>
    <div class="modal-field">
      <label>任务名称</label>
      <input type="text" id="modalTaskName" placeholder="输入任务名称">
    </div>
    <div class="modal-field">
      <label>负责人</label>
      <input type="text" id="modalOwner" placeholder="输入负责人">
    </div>
    <div style="display:flex; gap:10px;">
      <div class="modal-field" style="flex:1">
        <label>开始日期</label>
        <input type="date" id="modalStart">
      </div>
      <div class="modal-field" style="flex:1">
        <label>结束日期</label>
        <input type="date" id="modalEnd">
      </div>
    </div>
    <div class="modal-field">
      <label>进度 (<span id="modalProgressLabel">0</span>%)</label>
      <input type="range" id="modalProgress" min="0" max="100" value="0"
             oninput="document.getElementById('modalProgressLabel').textContent=this.value">
    </div>
    <div class="modal-field">
      <label>分类</label>
      <input type="text" id="modalCategory" placeholder="默认">
    </div>
    <div class="modal-actions">
      <button class="btn" onclick="closeTaskModal()">取消</button>
      <button class="btn btn-primary" onclick="saveTaskModal()">保存</button>
    </div>
  </div>
</div>

<!-- Context Menu -->
<div class="context-menu" id="contextMenu">
  <div class="context-menu-item" onclick="editTaskFromContext()">&#9998; 编辑任务</div>
  <div class="context-menu-item danger" onclick="deleteTaskFromContext()">&#128465; 删除任务</div>
</div>

<script>
// ═══════════════════════════════════════════════════════════════════════════
// STATE
// ═══════════════════════════════════════════════════════════════════════════
const uploadedFiles = [];
const FILE_COLORS = ['#4f8ff7','#f59e0b','#34d399','#ef4444','#a78bfa','#22d3ee','#f472b6','#818cf8'];
let RAW_TASKS = [];
const CATEGORY_COLORS = {};
const DEFAULT_CAT_COLORS = ['#4f8ff7','#a78bfa','#34d399','#f59e0b','#ef4444','#22d3ee','#f472b6','#818cf8','#fb923c','#2dd4bf'];
let catColorIdx = 0;
const FILE_SOURCES = [];
const FILE_COLOR_MAP = {};
let dayWidth = 32;
let collapsedFiles = new Set();
let collapsedCats = new Set();
let filteredTasks = [];
let showCriticalPath = false;
let heatmapOpen = false;
let hasUnsavedChanges = false;
let currentTheme = 'dark';
let editingTaskId = null;
let contextTaskId = null;
let inlineEditingId = null;
let currentRangeStart = null;
let currentTotalDays = 0;

// ═══════════════════════════════════════════════════════════════════════════
// THEME TOGGLE
// ═══════════════════════════════════════════════════════════════════════════
function toggleTheme() {
  currentTheme = currentTheme === 'dark' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', currentTheme === 'light' ? 'light' : '');
  if (currentTheme === 'dark') {
    document.documentElement.removeAttribute('data-theme');
  }
  const icon = currentTheme === 'dark' ? '\u263E' : '\u2600';
  const el1 = document.getElementById('themeIconUpload');
  const el2 = document.getElementById('themeIconGantt');
  if (el1) el1.textContent = icon;
  if (el2) el2.textContent = icon;
}

// ═══════════════════════════════════════════════════════════════════════════
// COLUMN DETECTION
// ═══════════════════════════════════════════════════════════════════════════
const FIELD_KEYWORDS = {
  task_id:    ["任务id","id","编号","taskid","序号","no","#"],
  task_name:  ["任务名称","任务名","任务","task","name","taskname","活动","activity","工作项","事项","标题","title","project","项目"],
  owner:      ["负责人","责任人","owner","assignee","执行人","成员","人员","responsible"],
  start_date: ["开始日期","开始时间","start","startdate","起始","begin"],
  end_date:   ["结束日期","结束时间","end","enddate","截止","finish","deadline","due"],
  progress:   ["进度","完成度","progress","完成","percent","完成率","completion"],
  priority:   ["优先级","priority","重要性","urgency","紧急程度"],
  status:     ["状态","status","state","阶段状态"],
  dependency: ["前置任务","依赖","前置","predecessor","dependency","depends","前序","blockedby"],
  category:   ["分类","类别","阶段","phase","category","group","模块","function","部门","职能"]
};

function normalize(s) { return s.replace(/[\s_\-()（）%]/g, '').toLowerCase().trim(); }

function detectColumns(headers) {
  const mapping = {};
  const claimed = new Set();
  const normH = headers.map(normalize);
  for (const [field, keywords] of Object.entries(FIELD_KEYWORDS)) {
    for (const kw of keywords) {
      const nkw = normalize(kw);
      if (!nkw) continue;
      for (let i = 0; i < normH.length; i++) {
        if (!normH[i] || claimed.has(i)) continue;
        if (nkw === normH[i] || (nkw.length >= 2 && normH[i].includes(nkw)) || (normH[i].length >= 2 && nkw.includes(normH[i]))) {
          mapping[field] = i; claimed.add(i); break;
        }
      }
      if (mapping[field] !== undefined) break;
    }
  }
  return mapping;
}

function parseDate(val) {
  if (!val) return null;
  if (val instanceof Date) {
    const y = val.getFullYear(), m = String(val.getMonth()+1).padStart(2,'0'), d = String(val.getDate()).padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  const s = String(val).trim();
  const m1 = s.match(/^(\d{4})[-/](\d{1,2})[-/](\d{1,2})/);
  if (m1) return `${m1[1]}-${m1[2].padStart(2,'0')}-${m1[3].padStart(2,'0')}`;
  const m2 = s.match(/^(\d{1,2})[-/](\d{1,2})[-/](\d{4})/);
  if (m2) return `${m2[3]}-${m2[1].padStart(2,'0')}-${m2[2].padStart(2,'0')}`;
  if (/^\d{5}$/.test(s)) {
    const d = new Date((parseInt(s) - 25569) * 86400000);
    if (!isNaN(d)) return parseDate(d);
  }
  return null;
}

function parseProgress(val) {
  if (val == null || val === '') return 0;
  const n = typeof val === 'number' ? val : parseFloat(String(val).replace('%',''));
  if (isNaN(n)) return 0;
  return Math.min(100, Math.max(0, Math.round(n > 1 ? n : n * 100)));
}

function parseFileData(rows, fileName) {
  let headerIdx = 0;
  for (let i = 0; i < Math.min(rows.length, 10); i++) {
    const nonEmpty = rows[i].filter(c => c != null && String(c).trim()).length;
    if (nonEmpty >= 2) { headerIdx = i; break; }
  }
  const headers = rows[headerIdx].map(c => c != null ? String(c).trim() : '');
  const colMap = detectColumns(headers);
  if (colMap.task_name === undefined) throw new Error(`无法识别任务名称列。列头: ${headers.join(', ')}`);
  if (colMap.start_date === undefined && colMap.end_date === undefined) throw new Error(`无法识别日期列。列头: ${headers.join(', ')}`);

  const get = (row, field) => {
    const idx = colMap[field];
    if (idx === undefined || idx >= row.length) return null;
    return row[idx];
  };

  const label = fileName.replace(/\.[^.]+$/, '').replace(/[_\-]\d{10,}[_\-]?\w*$/, '').replace(/_/g, ' ').trim();
  const tasks = [];
  for (let r = headerIdx + 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.every(c => c == null || String(c).trim() === '')) continue;
    const name = get(row, 'task_name');
    const start = parseDate(get(row, 'start_date'));
    const end = parseDate(get(row, 'end_date'));
    if (!name || (!start && !end)) continue;
    const finalStart = start || end;
    const finalEnd = end || start;
    tasks.push({
      id: String(get(row, 'task_id') || `T${String(r).padStart(3,'0')}`),
      name: String(name).trim(),
      owner: String(get(row, 'owner') || '').trim(),
      start: finalStart, end: finalEnd,
      progress: parseProgress(get(row, 'progress')),
      priority: String(get(row, 'priority') || '').trim(),
      status: String(get(row, 'status') || '').trim(),
      dependency: String(get(row, 'dependency') || '').trim(),
      category: String(get(row, 'category') || '默认').trim(),
      source: label
    });
  }
  return tasks;
}

// ═══════════════════════════════════════════════════════════════════════════
// FILE UPLOAD
// ═══════════════════════════════════════════════════════════════════════════
const dropZone = document.getElementById('dropZone');
const fileInput = document.getElementById('fileInput');
['dragenter','dragover'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.add('dragover'); }));
['dragleave','drop'].forEach(e => dropZone.addEventListener(e, ev => { ev.preventDefault(); dropZone.classList.remove('dragover'); }));
dropZone.addEventListener('drop', e => handleFiles(e.dataTransfer.files));
fileInput.addEventListener('change', e => handleFiles(e.target.files));

function handleFiles(files) {
  for (const file of files) {
    if (uploadedFiles.some(f => f.name === file.name && f.size === file.size)) continue;
    uploadedFiles.push(file);
  }
  renderFileList();
}
function removeFile(idx) { uploadedFiles.splice(idx, 1); renderFileList(); }
function renderFileList() {
  const list = document.getElementById('fileList');
  list.innerHTML = uploadedFiles.map((f, i) => {
    const ext = f.name.split('.').pop().toUpperCase();
    const color = FILE_COLORS[i % FILE_COLORS.length];
    const size = f.size > 1024*1024 ? (f.size/1024/1024).toFixed(1)+'MB' : (f.size/1024).toFixed(0)+'KB';
    return `<div class="file-item">
      <div class="file-icon-small" style="background:${color}">${ext}</div>
      <div class="file-info"><div class="file-name">${f.name}</div><div class="file-meta">${size}</div></div>
      <button class="file-remove" onclick="removeFile(${i})">×</button></div>`;
  }).join('');
  updateGenerateButton();
}

// generateGantt is now handled by startPreview() -> generateFromFiles() -> openPreview() -> confirmAndGenerate()

function showGanttScreen() {
  document.getElementById('uploadScreen').classList.add('hidden');
  document.getElementById('ganttScreen').classList.add('active');
  const sources = [...new Set(RAW_TASKS.map(t => t.source))];
  FILE_SOURCES.length = 0;
  sources.forEach(s => FILE_SOURCES.push(s));
  sources.forEach((s,i) => { FILE_COLOR_MAP[s] = FILE_COLORS[i % FILE_COLORS.length]; });
  const title = sources.length === 1 ? sources[0] + ' - 甘特图' : `合并甘特图 (${sources.length} 个文件)`;
  document.getElementById('chartTitle').textContent = title;
  buildFilters();
  render();
  setTimeout(fitAll, 100);
}

function goBack() {
  document.getElementById('ganttScreen').classList.remove('active');
  document.getElementById('uploadScreen').classList.remove('hidden');
  ['filterSource','filterCategory','filterOwner'].forEach(id => {
    const el = document.getElementById(id);
    el.innerHTML = '<option value="">全部</option>';
  });
  document.getElementById('searchInput').value = '';
  heatmapOpen = false;
  showCriticalPath = false;
  document.getElementById('heatmapPanel').classList.remove('open');
  document.getElementById('criticalPathBtn').classList.remove('active');
  document.getElementById('heatmapBtn').classList.remove('active');
}

// ═══════════════════════════════════════════════════════════════════════════
// UNSAVED CHANGES
// ═══════════════════════════════════════════════════════════════════════════
function markUnsaved() {
  hasUnsavedChanges = true;
  updateUnsavedBadge();
}
function updateUnsavedBadge() {
  const b = document.getElementById('unsavedBadge');
  const e = document.getElementById('exportExcelBtn');
  if (hasUnsavedChanges) {
    b.classList.add('visible');
    e.style.display = 'inline-block';
  } else {
    b.classList.remove('visible');
    e.style.display = 'none';
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// HELPERS
// ═══════════════════════════════════════════════════════════════════════════
function getCategoryColor(cat) {
  if (CATEGORY_COLORS[cat]) return CATEGORY_COLORS[cat];
  CATEGORY_COLORS[cat] = DEFAULT_CAT_COLORS[catColorIdx++ % DEFAULT_CAT_COLORS.length];
  return CATEGORY_COLORS[cat];
}
function getProgressColor(p) {
  if (p >= 100) return '#34d399'; if (p >= 60) return '#4f8ff7';
  if (p >= 30) return '#f59e0b'; return '#ef4444';
}
function pd(s) { return new Date(s + 'T00:00:00'); }
function db(a, b) { return Math.round((b - a) / 86400000); }
function ad(d, n) { const r = new Date(d); r.setDate(r.getDate() + n); return r; }
function iw(d) { const day = d.getDay(); return day === 0 || day === 6; }
function fmtDate(d) {
  const y = d.getFullYear(), m = String(d.getMonth()+1).padStart(2,'0'), dd = String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${dd}`;
}
const MN = ['1月','2月','3月','4月','5月','6月','7月','8月','9月','10月','11月','12月'];

function computeRange(tasks) {
  let minD = Infinity, maxD = -Infinity;
  tasks.forEach(t => {
    const s = pd(t.start).getTime(), e = pd(t.end).getTime();
    if (s < minD) minD = s; if (e > maxD) maxD = e;
  });
  const rangeStart = ad(new Date(minD), -3);
  return { rangeStart, totalDays: db(rangeStart, ad(new Date(maxD), 5)) + 1 };
}

// ═══════════════════════════════════════════════════════════════════════════
// CONFLICT DETECTION
// ═══════════════════════════════════════════════════════════════════════════
function getConflictOwners() {
  const ownerTasks = {};
  filteredTasks.forEach(t => {
    if (!t.owner) return;
    if (!ownerTasks[t.owner]) ownerTasks[t.owner] = [];
    ownerTasks[t.owner].push({ start: pd(t.start).getTime(), end: pd(t.end).getTime() });
  });
  const conflicts = new Set();
  for (const [owner, tasks] of Object.entries(ownerTasks)) {
    tasks.sort((a,b) => a.start - b.start);
    for (let i = 0; i < tasks.length - 1; i++) {
      for (let j = i + 1; j < tasks.length; j++) {
        if (tasks[j].start < tasks[i].end) {
          conflicts.add(owner);
          break;
        }
      }
      if (conflicts.has(owner)) break;
    }
  }
  return conflicts;
}

// ═══════════════════════════════════════════════════════════════════════════
// CRITICAL PATH
// ═══════════════════════════════════════════════════════════════════════════
function computeCriticalPath() {
  // Build dependency graph and find longest path
  const tasks = filteredTasks;
  const taskMap = {};
  tasks.forEach(t => { taskMap[t.id] = t; });

  // Build adjacency (dependency -> dependant)
  const adj = {};
  const inDeg = {};
  tasks.forEach(t => { adj[t.id] = []; inDeg[t.id] = 0; });

  tasks.forEach(t => {
    if (!t.dependency) return;
    t.dependency.split(/[,;、\s]+/).filter(Boolean).forEach(depId => {
      if (taskMap[depId]) {
        if (!adj[depId]) adj[depId] = [];
        adj[depId].push(t.id);
        inDeg[t.id] = (inDeg[t.id] || 0) + 1;
      }
    });
  });

  // Compute duration
  function duration(t) {
    return db(pd(t.start), pd(t.end)) + 1;
  }

  // Topological sort + longest path
  const dist = {};
  const prev = {};
  tasks.forEach(t => { dist[t.id] = duration(t); prev[t.id] = null; });

  // Topo sort using Kahn's
  const queue = [];
  tasks.forEach(t => { if ((inDeg[t.id] || 0) === 0) queue.push(t.id); });
  const order = [];
  while (queue.length) {
    const u = queue.shift();
    order.push(u);
    (adj[u] || []).forEach(v => {
      const newDist = dist[u] + duration(taskMap[v]);
      if (newDist > dist[v]) {
        dist[v] = newDist;
        prev[v] = u;
      }
      inDeg[v]--;
      if (inDeg[v] === 0) queue.push(v);
    });
  }

  // Find the end of critical path
  let maxId = null, maxDist = 0;
  tasks.forEach(t => {
    if (dist[t.id] > maxDist) { maxDist = dist[t.id]; maxId = t.id; }
  });

  // Trace back
  const cpSet = new Set();
  let cur = maxId;
  while (cur) {
    cpSet.add(cur);
    cur = prev[cur];
  }
  return cpSet;
}

function toggleCriticalPath() {
  showCriticalPath = !showCriticalPath;
  document.getElementById('criticalPathBtn').classList.toggle('active', showCriticalPath);
  render();
}

// ═══════════════════════════════════════════════════════════════════════════
// HEATMAP
// ═══════════════════════════════════════════════════════════════════════════
function toggleHeatmap() {
  heatmapOpen = !heatmapOpen;
  document.getElementById('heatmapBtn').classList.toggle('active', heatmapOpen);
  const panel = document.getElementById('heatmapPanel');
  if (heatmapOpen) {
    renderHeatmap();
    panel.classList.add('open');
  } else {
    panel.classList.remove('open');
  }
}

function renderHeatmap() {
  const panel = document.getElementById('heatmapPanel');
  const tasks = filteredTasks.filter(t => t.owner);
  if (!tasks.length) { panel.innerHTML = '<div class="heatmap-title">无负责人数据</div>'; return; }

  // Get range
  const { rangeStart, totalDays } = computeRange(tasks);
  // Group by week
  const weeks = [];
  let wd = new Date(rangeStart);
  // Align to Monday
  while (wd.getDay() !== 1) wd = ad(wd, -1);
  const endDate = ad(rangeStart, totalDays);
  while (wd < endDate) {
    weeks.push(new Date(wd));
    wd = ad(wd, 7);
  }

  // Owners
  const owners = [...new Set(tasks.map(t => t.owner))].sort();

  // Count tasks per owner per week
  const data = {};
  let maxCount = 0;
  owners.forEach(o => { data[o] = new Array(weeks.length).fill(0); });
  tasks.forEach(t => {
    const ts = pd(t.start).getTime(), te = pd(t.end).getTime();
    weeks.forEach((w, wi) => {
      const ws = w.getTime(), we = ws + 7*86400000;
      if (ts < we && te >= ws) {
        data[t.owner][wi]++;
        if (data[t.owner][wi] > maxCount) maxCount = data[t.owner][wi];
      }
    });
  });

  function heatColor(count) {
    if (count === 0) return 'rgba(79,143,247,0.05)';
    const intensity = Math.min(1, count / Math.max(maxCount, 1));
    const r = Math.round(79 + (239-79)*intensity);
    const g = Math.round(143 + (68-143)*intensity);
    const b = Math.round(247 + (68-247)*intensity);
    return `rgba(${r},${g},${b},${0.3 + intensity * 0.7})`;
  }

  let weekLabels = weeks.map(w => {
    const m = w.getMonth()+1, d = w.getDate();
    return `${m}/${d}`;
  }).map(l => `<div class="heatmap-week-label">${l}</div>`).join('');

  let rowsHtml = owners.map(o => {
    const cells = data[o].map(c =>
      `<div class="heatmap-cell" style="background:${heatColor(c)}" title="${o}: ${c} 个任务">${c||''}</div>`
    ).join('');
    return `<div class="heatmap-row"><div class="heatmap-label" title="${o}">${o}</div><div class="heatmap-cells">${cells}</div></div>`;
  }).join('');

  panel.innerHTML = `
    <div class="heatmap-title">&#128293; 资源负载热力图 (按周)</div>
    <div class="heatmap-week-labels">${weekLabels}</div>
    <div class="heatmap-grid">${rowsHtml}</div>`;
}

// ═══════════════════════════════════════════════════════════════════════════
// FILTERS
// ═══════════════════════════════════════════════════════════════════════════
function buildFilters() {
  const add = (id, vals) => {
    const sel = document.getElementById(id);
    sel.innerHTML = '<option value="">全部</option>';
    if (id === 'filterSource') sel.innerHTML = '<option value="">全部文件</option>';
    vals.forEach(v => { const o = document.createElement('option'); o.value = v; o.textContent = v; sel.appendChild(o); });
    sel.onchange = applyFilters;
  };
  add('filterSource', [...new Set(RAW_TASKS.map(t => t.source))]);
  add('filterCategory', [...new Set(RAW_TASKS.map(t => t.category))]);
  add('filterOwner', [...new Set(RAW_TASKS.map(t => t.owner).filter(Boolean))]);
  document.getElementById('searchInput').oninput = applyFilters;
}

function applyFilters() {
  const src = document.getElementById('filterSource').value;
  const cat = document.getElementById('filterCategory').value;
  const own = document.getElementById('filterOwner').value;
  const q = document.getElementById('searchInput').value.toLowerCase();
  filteredTasks = RAW_TASKS.filter(t => {
    if (src && t.source !== src) return false;
    if (cat && t.category !== cat) return false;
    if (own && t.owner !== own) return false;
    if (q && !t.name.toLowerCase().includes(q)) return false;
    return true;
  });
  render();
  if (heatmapOpen) renderHeatmap();
}

// ═══════════════════════════════════════════════════════════════════════════
// RENDER
// ═══════════════════════════════════════════════════════════════════════════
const RH = 32;

function render() {
  // Stats
  const total = filteredTasks.length;
  const done = filteredTasks.filter(t => t.progress >= 100).length;
  const avg = total ? Math.round(filteredTasks.reduce((a,t) => a+t.progress, 0)/total) : 0;
  const active = filteredTasks.filter(t => t.progress > 0 && t.progress < 100).length;
  const fc = new Set(filteredTasks.map(t => t.source)).size;
  document.getElementById('headerStats').innerHTML = `
    <div class="stat-card"><div class="num">${fc}</div><div class="label">文件</div></div>
    <div class="stat-card"><div class="num">${total}</div><div class="label">任务</div></div>
    <div class="stat-card"><div class="num" style="color:#34d399">${done}</div><div class="label">完成</div></div>
    <div class="stat-card"><div class="num" style="color:#f59e0b">${active}</div><div class="label">进行中</div></div>
    <div class="stat-card"><div class="num" style="color:#a78bfa">${avg}%</div><div class="label">进度</div></div>`;

  const useTasks = filteredTasks.length ? filteredTasks : RAW_TASKS;
  if (!useTasks.length) return;
  const { rangeStart, totalDays } = computeRange(useTasks);
  currentRangeStart = rangeStart;
  currentTotalDays = totalDays;
  const cw = totalDays * dayWidth;

  // Critical path
  let cpSet = new Set();
  if (showCriticalPath) cpSet = computeCriticalPath();

  // Conflict owners
  const conflictOwners = getConflictOwners();

  // Header
  let mHTML = '', dHTML = '', d = new Date(rangeStart), cm = -1, mc = 0;
  const today = new Date(); today.setHours(0,0,0,0);
  let py = rangeStart.getFullYear();
  for (let i = 0; i < totalDays; i++) {
    const m = d.getMonth(), y = d.getFullYear();
    if (m !== cm) {
      if (cm !== -1) mHTML += `<div class="month-cell" style="width:${mc*dayWidth}px">${MN[cm]} ${py}</div>`;
      cm = m; py = y; mc = 0;
    }
    mc++;
    const we = iw(d), isT = d.getTime() === today.getTime();
    let cls = 'day-cell'; if (we) cls += ' weekend'; if (isT) cls += ' today';
    dHTML += `<div class="${cls}" style="width:${dayWidth}px">${d.getDate()}</div>`;
    d = ad(d, 1);
  }
  mHTML += `<div class="month-cell" style="width:${mc*dayWidth}px">${MN[cm]} ${py}</div>`;
  document.getElementById('chartHeader').innerHTML =
    `<div class="chart-header-months" style="width:${cw}px">${mHTML}</div>` +
    `<div class="chart-header-days" style="width:${cw}px">${dHTML}</div>`;

  // Group: source -> category
  const fg = {};
  filteredTasks.forEach(t => {
    if (!fg[t.source]) fg[t.source] = {};
    if (!fg[t.source][t.category]) fg[t.source][t.category] = [];
    fg[t.source][t.category].push(t);
  });

  let tHTML = '', bHTML = '', ri = 0;
  const bp = {};

  function cells(h) {
    let s = '';
    for (let i = 0; i < totalDays; i++) {
      const dd = ad(rangeStart, i); let c = 'chart-cell'; if (iw(dd)) c += ' weekend';
      s += `<div class="${c}" style="width:${dayWidth}px;height:${h}px"></div>`;
    }
    return s;
  }

  for (const [src, cgs] of Object.entries(fg)) {
    const fc = FILE_COLOR_MAP[src] || '#4f8ff7';
    const ft = Object.values(cgs).flat();
    const fColl = collapsedFiles.has(src);
    const fArr = fColl ? 'group-arrow collapsed' : 'group-arrow';
    const fp = ft.length ? Math.round(ft.reduce((a,t)=>a+t.progress,0)/ft.length) : 0;
    const es = src.replace(/'/g, "\\'");

    tHTML += `<div class="file-group-header" onclick="toggleFile('${es}')" style="border-left:4px solid ${fc}">
      <span class="${fArr}">&#9660;</span>
      <div class="fg-icon" style="background:${fc}">${src.charAt(0).toUpperCase()}</div>
      <span style="color:${fc}">${src}</span>
      <div class="fg-stats">${ft.length} 任务 · ${fp}%</div></div>`;
    bHTML += `<div class="chart-row file-header-row" style="height:${RH+2}px;width:${cw}px">${cells(RH+2)}</div>`;
    ri++;

    if (fColl) continue;

    for (const [cat, tasks] of Object.entries(cgs)) {
      const ck = src+'::'+cat, cc = collapsedCats.has(ck);
      const ca = cc ? 'group-arrow collapsed' : 'group-arrow';
      const clr = getCategoryColor(cat);
      const eck = ck.replace(/'/g, "\\'");

      tHTML += `<div class="cat-group-header" onclick="toggleCat('${eck}')" style="border-left:3px solid ${clr}">
        <span class="${ca}">&#9660;</span><span style="color:${clr}">${cat}</span>
        <span style="color:var(--text-muted);font-size:10px;margin-left:auto">${tasks.length}</span></div>`;
      bHTML += `<div class="chart-row cat-header-row" style="height:${RH}px;width:${cw}px">${cells(RH)}</div>`;
      ri++;

      if (cc) continue;

      tasks.forEach(t => {
        const pc = getProgressColor(t.progress);
        const did = t.id.replace(/^F\d+_/, '');
        const isCritical = cpSet.has(t.id);
        const hasConflict = t.owner && conflictOwners.has(t.owner);
        const eid = t.id.replace(/'/g, "\\'");

        // Inline editing check
        if (inlineEditingId === t.id) {
          tHTML += buildInlineEditForm(t);
        } else {
          tHTML += `<div class="task-row" data-taskid="${t.id}"
            onmouseenter="hlR('${eid}')" onmouseleave="ulR('${eid}')"
            ondblclick="startInlineEdit('${eid}')"
            oncontextmenu="showContextMenu(event,'${eid}')">
            <div class="task-id" title="${t.id}">${did}</div>
            <div class="task-name" style="border-left:3px solid ${clr};padding-left:6px" title="${t.name}">${t.name}</div>
            <div class="task-owner">${hasConflict ? '<span class="conflict-warn" title="该负责人存在任务时间冲突">&#9888;</span>' : ''}${t.owner}</div>
            <div class="task-progress-cell">
              <div class="mini-progress"><div class="mini-progress-fill" style="width:${t.progress}%;background:${pc}"></div></div>
              <span style="font-size:10px;color:${pc}">${t.progress}%</span></div></div>`;
        }

        const ts = pd(t.start), te = pd(t.end);
        const isMilestone = t.start === t.end;
        const so = db(rangeStart, ts) * dayWidth;
        const bw = Math.max((db(ts, te) + 1) * dayWidth - 4, 16);
        bp[t.id] = { x: so + bw, y: ri * RH + RH / 2, startX: so };

        let bar;
        if (isMilestone) {
          const mx = so + dayWidth / 2;
          bar = `<div class="gantt-milestone ${isCritical ? 'critical-path' : ''}" style="left:${mx}px;background:${clr}"
            data-taskid="${t.id}" onmouseenter="showTT(event,'${eid}')"
            onmouseleave="hideTT()" onmousemove="moveTT(event)"></div>`;
        } else {
          const inProgressClass = (t.progress > 0 && t.progress < 100) ? ' in-progress' : '';
          bar = `<div class="gantt-bar-wrapper" style="left:${so}px;width:${bw}px"
            data-taskid="${t.id}" onmouseenter="showTT(event,'${eid}')"
            onmouseleave="hideTT()" onmousemove="moveTT(event)">
            <div class="gantt-bar ${isCritical ? 'critical-path' : ''}">
              <div class="gantt-bar-bg" style="background:${clr}"></div>
              <div class="gantt-bar-progress${inProgressClass}" style="width:${t.progress}%;background:${clr}"></div>
              <div class="gantt-bar-text">${t.name}</div>
              <div class="bar-resize-handle left" data-taskid="${t.id}" data-side="left"></div>
              <div class="bar-resize-handle right" data-taskid="${t.id}" data-side="right"></div>
            </div></div>`;
        }

        bHTML += `<div class="chart-row" data-taskid="${t.id}" style="height:${RH}px;width:${cw}px"
          onmouseenter="hlR('${eid}')" onmouseleave="ulR('${eid}')">
          ${cells(RH)}${bar}</div>`;
        ri++;
      });
    }
  }

  document.getElementById('taskList').innerHTML = tHTML;
  document.getElementById('chartBody').innerHTML = bHTML;

  // Today line
  const to = db(rangeStart, today);
  if (to >= 0 && to <= totalDays) {
    const tl = document.createElement('div');
    tl.className = 'today-line';
    tl.style.left = (to * dayWidth + dayWidth/2) + 'px';
    document.getElementById('chartBody').appendChild(tl);
  }

  // Dependencies
  let lines = '';
  filteredTasks.forEach(t => {
    if (!t.dependency) return;
    t.dependency.split(/[,;、\s]+/).filter(Boolean).forEach(did => {
      const from = bp[did], to2 = bp[t.id];
      if (!from || !to2) return;
      const x1=from.x+2, y1=from.y, x2=to2.startX-2, y2=to2.y, mx=x1+(x2-x1)*0.5;
      lines += `<path class="dep-line" d="M${x1},${y1} C${mx},${y1} ${mx},${y2} ${x2},${y2}"/>`;
      lines += `<polygon class="dep-arrow" points="${x2},${y2} ${x2-5},${y2-3} ${x2-5},${y2+3}"/>`;
    });
  });
  if (lines) {
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.classList.add('dependency-svg');
    svg.setAttribute('width', cw); svg.setAttribute('height', ri * RH);
    svg.innerHTML = lines;
    document.getElementById('chartBody').appendChild(svg);
  }

  // Sync scroll
  const cp = document.getElementById('chartPanel'), tl2 = document.getElementById('taskList');
  cp.onscroll = () => { tl2.scrollTop = cp.scrollTop; };
  tl2.onscroll = () => { cp.scrollTop = tl2.scrollTop; };

  // Setup bar resize listeners
  setupBarResize();
}

// ═══════════════════════════════════════════════════════════════════════════
// INTERACTIONS
// ═══════════════════════════════════════════════════════════════════════════
function toggleFile(s) { collapsedFiles.has(s) ? collapsedFiles.delete(s) : collapsedFiles.add(s); render(); }
function toggleCat(k) { collapsedCats.has(k) ? collapsedCats.delete(k) : collapsedCats.add(k); render(); }
function collapseAll() { FILE_SOURCES.forEach(s => collapsedFiles.add(s)); render(); }
function expandAll() { collapsedFiles.clear(); collapsedCats.clear(); render(); }
function hlR(id) { document.querySelectorAll(`[data-taskid="${id}"]`).forEach(e => e.classList.add('highlight')); }
function ulR(id) { document.querySelectorAll(`[data-taskid="${id}"]`).forEach(e => e.classList.remove('highlight')); }

function showTT(e, id) {
  const t = filteredTasks.find(x => x.id === id); if (!t) return;
  const tt = document.getElementById('tooltip');
  const clr = getCategoryColor(t.category), pc = getProgressColor(t.progress);
  const fc = FILE_COLOR_MAP[t.source] || '#4f8ff7';
  const isMilestone = t.start === t.end;
  tt.innerHTML = `
    <div class="tt-source" style="border-left:3px solid ${fc}">${t.source}</div>
    <div class="tt-title" style="color:${clr}">${t.name}${isMilestone ? ' (里程碑)' : ''}</div>
    <div class="tt-row"><span class="tt-label">分类</span><span class="tt-value">${t.category}</span></div>
    <div class="tt-row"><span class="tt-label">负责人</span><span class="tt-value">${t.owner||'—'}</span></div>
    <div class="tt-row"><span class="tt-label">开始</span><span class="tt-value">${t.start}</span></div>
    <div class="tt-row"><span class="tt-label">结束</span><span class="tt-value">${t.end}</span></div>
    ${t.status ? `<div class="tt-row"><span class="tt-label">状态</span><span class="tt-value">${t.status}</span></div>` : ''}
    <div class="tt-row"><span class="tt-label">进度</span><span class="tt-value" style="color:${pc}">${t.progress}%</span></div>
    <div class="tt-progress-bar"><div class="tt-progress-fill" style="width:${t.progress}%;background:${pc}"></div></div>`;
  tt.classList.add('visible');
  moveTT(e);
}
function moveTT(e) {
  const tt = document.getElementById('tooltip');
  let x = e.clientX+14, y = e.clientY+14;
  if (x+320 > window.innerWidth) x = e.clientX-330;
  if (y+200 > window.innerHeight) y = e.clientY-200;
  tt.style.left = x+'px'; tt.style.top = y+'px';
}
function hideTT() { document.getElementById('tooltip').classList.remove('visible'); }

function zoomIn() { dayWidth = Math.min(80, dayWidth+8); render(); }
function zoomOut() { dayWidth = Math.max(8, dayWidth-8); render(); }
function fitAll() {
  const cw = document.getElementById('chartPanel').clientWidth;
  const ut = filteredTasks.length ? filteredTasks : RAW_TASKS;
  if (!ut.length) return;
  const { totalDays } = computeRange(ut);
  dayWidth = Math.max(8, Math.min(80, Math.floor(cw / totalDays)));
  render();
}
function scrollToToday() {
  const ut = filteredTasks.length ? filteredTasks : RAW_TASKS;
  if (!ut.length) return;
  const { rangeStart } = computeRange(ut);
  const today = new Date(); today.setHours(0,0,0,0);
  document.getElementById('chartPanel').scrollLeft = Math.max(0, db(rangeStart, today) * dayWidth - 200);
}

// ═══════════════════════════════════════════════════════════════════════════
// BAR RESIZE (Drag Start/End)
// ═══════════════════════════════════════════════════════════════════════════
function setupBarResize() {
  const handles = document.querySelectorAll('.bar-resize-handle');
  handles.forEach(h => {
    h.addEventListener('mousedown', startBarResize);
  });
}

function startBarResize(e) {
  e.preventDefault();
  e.stopPropagation();
  const taskId = e.target.dataset.taskid;
  const side = e.target.dataset.side;
  const task = filteredTasks.find(t => t.id === taskId);
  if (!task) return;

  const wrapper = e.target.closest('.gantt-bar-wrapper');
  const chartPanel = document.getElementById('chartPanel');
  const dragTip = document.getElementById('dragDateTip');
  const startX = e.clientX;
  const origLeft = parseInt(wrapper.style.left);
  const origWidth = parseInt(wrapper.style.width);
  const rangeStart = currentRangeStart;

  dragTip.classList.add('visible');

  function onMove(ev) {
    const dx = ev.clientX - startX;
    let newLeft = origLeft, newWidth = origWidth;
    if (side === 'left') {
      newLeft = origLeft + dx;
      newWidth = origWidth - dx;
      if (newWidth < 16) return;
    } else {
      newWidth = origWidth + dx;
      if (newWidth < 16) return;
    }
    wrapper.style.left = newLeft + 'px';
    wrapper.style.width = newWidth + 'px';

    // Calculate dates
    const startDay = Math.round(newLeft / dayWidth);
    const endDay = Math.round((newLeft + newWidth) / dayWidth) - 1;
    const newStart = ad(rangeStart, startDay);
    const newEnd = ad(rangeStart, Math.max(startDay, endDay));

    dragTip.textContent = `${fmtDate(newStart)} ~ ${fmtDate(newEnd)}`;
    dragTip.style.left = (ev.clientX + 12) + 'px';
    dragTip.style.top = (ev.clientY - 30) + 'px';
  }

  function onUp(ev) {
    document.removeEventListener('mousemove', onMove);
    document.removeEventListener('mouseup', onUp);
    dragTip.classList.remove('visible');

    const dx = ev.clientX - startX;
    let newLeft = origLeft, newWidth = origWidth;
    if (side === 'left') {
      newLeft = origLeft + dx;
      newWidth = origWidth - dx;
      if (newWidth < 16) { newLeft = origLeft; newWidth = origWidth; }
    } else {
      newWidth = origWidth + dx;
      if (newWidth < 16) newWidth = origWidth;
    }

    const startDay = Math.round(newLeft / dayWidth);
    const endDay = Math.round((newLeft + newWidth) / dayWidth) - 1;
    const newStart = ad(rangeStart, startDay);
    const newEnd = ad(rangeStart, Math.max(startDay, endDay));

    task.start = fmtDate(newStart);
    task.end = fmtDate(newEnd);

    // Also update in RAW_TASKS
    const rawTask = RAW_TASKS.find(t => t.id === taskId);
    if (rawTask) { rawTask.start = task.start; rawTask.end = task.end; }

    markUnsaved();
    render();
  }

  document.addEventListener('mousemove', onMove);
  document.addEventListener('mouseup', onUp);
}

// ═══════════════════════════════════════════════════════════════════════════
// INLINE EDITING
// ═══════════════════════════════════════════════════════════════════════════
function buildInlineEditForm(t) {
  return `<div class="inline-edit-form" data-taskid="${t.id}">
    <div class="task-id" style="font-size:10px;color:var(--text-muted);font-family:monospace">${t.id.replace(/^F\d+_/,'')}</div>
    <div class="ie-fields">
      <input type="text" id="ie_name" value="${t.name.replace(/"/g,'&quot;')}" placeholder="任务名称">
      <div style="display:flex;gap:4px">
        <input type="date" id="ie_start" value="${t.start}" style="flex:1">
        <input type="date" id="ie_end" value="${t.end}" style="flex:1">
      </div>
      <input type="text" id="ie_category" value="${t.category.replace(/"/g,'&quot;')}" placeholder="分类">
    </div>
    <div>
      <input type="text" id="ie_owner" value="${t.owner.replace(/"/g,'&quot;')}" placeholder="负责人" style="width:60px;font-size:10px;padding:2px 4px;border-radius:4px;border:1px solid var(--border-color);background:var(--bg-tertiary);color:var(--text-primary);">
    </div>
    <div class="ie-actions">
      <button class="ie-save" onclick="saveInlineEdit('${t.id.replace(/'/g,"\\'")}')">&#10003;</button>
      <button class="ie-cancel" onclick="cancelInlineEdit()">&#10005;</button>
      <input type="range" id="ie_progress" min="0" max="100" value="${t.progress}" style="width:50px" title="进度: ${t.progress}%">
    </div>
  </div>`;
}

function startInlineEdit(id) {
  inlineEditingId = id;
  render();
}

function saveInlineEdit(id) {
  const task = RAW_TASKS.find(t => t.id === id);
  const fTask = filteredTasks.find(t => t.id === id);
  if (!task) return;

  const name = document.getElementById('ie_name').value.trim();
  const owner = document.getElementById('ie_owner').value.trim();
  const start = document.getElementById('ie_start').value;
  const end = document.getElementById('ie_end').value;
  const progress = parseInt(document.getElementById('ie_progress').value);
  const category = document.getElementById('ie_category').value.trim();

  if (name) task.name = name;
  if (start) task.start = start;
  if (end) task.end = end;
  task.owner = owner;
  task.progress = progress;
  if (category) task.category = category;

  if (fTask && fTask !== task) {
    Object.assign(fTask, { name: task.name, owner: task.owner, start: task.start, end: task.end, progress: task.progress, category: task.category });
  }

  inlineEditingId = null;
  markUnsaved();
  buildFilters();
  applyFilters();
}

function cancelInlineEdit() {
  inlineEditingId = null;
  render();
}

// ═══════════════════════════════════════════════════════════════════════════
// CONTEXT MENU
// ═══════════════════════════════════════════════════════════════════════════
function showContextMenu(e, id) {
  e.preventDefault();
  contextTaskId = id;
  const menu = document.getElementById('contextMenu');
  menu.style.left = e.clientX + 'px';
  menu.style.top = e.clientY + 'px';
  menu.classList.add('active');
}

document.addEventListener('click', () => {
  document.getElementById('contextMenu').classList.remove('active');
});

function editTaskFromContext() {
  if (!contextTaskId) return;
  startInlineEdit(contextTaskId);
  document.getElementById('contextMenu').classList.remove('active');
}

function deleteTaskFromContext() {
  if (!contextTaskId) return;
  const task = RAW_TASKS.find(t => t.id === contextTaskId);
  if (task && confirm(`确定删除任务「${task.name}」？`)) {
    RAW_TASKS = RAW_TASKS.filter(t => t.id !== contextTaskId);
    filteredTasks = filteredTasks.filter(t => t.id !== contextTaskId);
    markUnsaved();
    buildFilters();
    render();
  }
  document.getElementById('contextMenu').classList.remove('active');
}

// ═══════════════════════════════════════════════════════════════════════════
// ADD TASK MODAL
// ═══════════════════════════════════════════════════════════════════════════
function openAddTaskModal() {
  editingTaskId = null;
  document.getElementById('modalTitle').textContent = '添加任务';
  document.getElementById('modalTaskName').value = '';
  document.getElementById('modalOwner').value = '';
  document.getElementById('modalStart').value = fmtDate(new Date());
  document.getElementById('modalEnd').value = fmtDate(ad(new Date(), 7));
  document.getElementById('modalProgress').value = 0;
  document.getElementById('modalProgressLabel').textContent = '0';
  document.getElementById('modalCategory').value = '默认';
  document.getElementById('taskModal').classList.add('active');
}

function closeTaskModal() {
  document.getElementById('taskModal').classList.remove('active');
  editingTaskId = null;
}

function saveTaskModal() {
  const name = document.getElementById('modalTaskName').value.trim();
  const owner = document.getElementById('modalOwner').value.trim();
  const start = document.getElementById('modalStart').value;
  const end = document.getElementById('modalEnd').value;
  const progress = parseInt(document.getElementById('modalProgress').value);
  const category = document.getElementById('modalCategory').value.trim() || '默认';

  if (!name) { alert('请输入任务名称'); return; }
  if (!start || !end) { alert('请选择日期'); return; }

  const source = FILE_SOURCES.length ? FILE_SOURCES[0] : '手动添加';
  const newId = 'M_T' + Date.now();

  const task = {
    id: newId, name, owner, start, end, progress,
    priority: '', status: '', dependency: '',
    category, source
  };

  RAW_TASKS.push(task);
  filteredTasks.push(task);
  if (!FILE_SOURCES.includes(source)) FILE_SOURCES.push(source);
  if (!FILE_COLOR_MAP[source]) FILE_COLOR_MAP[source] = FILE_COLORS[FILE_SOURCES.length % FILE_COLORS.length];

  markUnsaved();
  closeTaskModal();
  buildFilters();
  render();
}

// ═══════════════════════════════════════════════════════════════════════════
// EXPORT PNG / PDF
// ═══════════════════════════════════════════════════════════════════════════
async function exportPNG() {
  const ganttMain = document.querySelector('.gantt-main');
  if (!ganttMain) return;
  document.getElementById('loading').classList.add('active');
  document.querySelector('.loading-text').textContent = '正在生成 PNG...';
  try {
    // Capture the chart area
    const chartPanel = document.getElementById('chartPanel');
    const taskPanel = document.getElementById('taskPanel');
    // Create a wrapper to capture both panels side by side
    const wrapper = document.createElement('div');
    wrapper.style.display = 'flex';
    wrapper.style.width = (taskPanel.offsetWidth + chartPanel.scrollWidth) + 'px';
    wrapper.style.background = getComputedStyle(document.body).backgroundColor;

    const canvas = await html2canvas(ganttMain, {
      scale: 2,
      useCORS: true,
      backgroundColor: getComputedStyle(document.body).backgroundColor,
      scrollX: 0,
      scrollY: 0,
      width: ganttMain.scrollWidth,
      height: ganttMain.scrollHeight,
      windowWidth: ganttMain.scrollWidth,
      windowHeight: ganttMain.scrollHeight
    });
    const link = document.createElement('a');
    link.download = 'gantt_chart.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  } catch (err) {
    alert('导出 PNG 失败: ' + err.message);
    console.error(err);
  } finally {
    document.getElementById('loading').classList.remove('active');
    document.querySelector('.loading-text').textContent = '正在解析文件...';
  }
}

async function exportPDF() {
  const ganttMain = document.querySelector('.gantt-main');
  if (!ganttMain) return;
  document.getElementById('loading').classList.add('active');
  document.querySelector('.loading-text').textContent = '正在生成 PDF...';
  try {
    const canvas = await html2canvas(ganttMain, {
      scale: 2,
      useCORS: true,
      backgroundColor: getComputedStyle(document.body).backgroundColor,
      scrollX: 0,
      scrollY: 0,
      width: ganttMain.scrollWidth,
      height: ganttMain.scrollHeight,
      windowWidth: ganttMain.scrollWidth,
      windowHeight: ganttMain.scrollHeight
    });
    const imgData = canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF({
      orientation: 'landscape',
      unit: 'px',
      format: [canvas.width / 2, canvas.height / 2]
    });
    pdf.addImage(imgData, 'PNG', 0, 0, canvas.width / 2, canvas.height / 2);
    pdf.save('gantt_chart.pdf');
  } catch (err) {
    alert('导出 PDF 失败: ' + err.message);
    console.error(err);
  } finally {
    document.getElementById('loading').classList.remove('active');
    document.querySelector('.loading-text').textContent = '正在解析文件...';
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// EXPORT EXCEL
// ═══════════════════════════════════════════════════════════════════════════
function exportExcel() {
  const headers = ['ID', '任务名称', '负责人', '开始日期', '结束日期', '进度', '优先级', '状态', '前置任务', '分类', '来源'];
  const data = RAW_TASKS.map(t => [
    t.id, t.name, t.owner, t.start, t.end, t.progress + '%',
    t.priority, t.status, t.dependency, t.category, t.source
  ]);
  data.unshift(headers);
  const ws = XLSX.utils.aoa_to_sheet(data);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, '甘特图数据');
  XLSX.writeFile(wb, 'gantt_data.xlsx');
}

// ═══════════════════════════════════════════════════════════════════════════
// PANEL RESIZE
// ═══════════════════════════════════════════════════════════════════════════
(function() {
  const h = document.getElementById('resizeHandle'), p = document.getElementById('taskPanel');
  let sx, sw;
  h.onmousedown = e => {
    e.preventDefault(); sx = e.clientX; sw = p.offsetWidth;
    document.onmousemove = ev => { p.style.width = Math.max(200, Math.min(600, sw+ev.clientX-sx))+'px'; };
    document.onmouseup = () => { document.onmousemove = null; document.onmouseup = null; };
  };
})();

// ═══════════════════════════════════════════════════════════════════════════
// INPUT TAB SWITCHING
// ═══════════════════════════════════════════════════════════════════════════
let currentInputMode = 'file';
let parsedTextTasks = [];

function switchInputTab(mode) {
  currentInputMode = mode;
  document.getElementById('tabFile').classList.toggle('active', mode === 'file');
  document.getElementById('tabUrl').classList.toggle('active', mode === 'url');
  document.getElementById('tabText').classList.toggle('active', mode === 'text');
  document.getElementById('fileUploadPanel').style.display = mode === 'file' ? 'block' : 'none';
  document.getElementById('urlFetchPanel').classList.toggle('active', mode === 'url');
  document.getElementById('textParsePanel').classList.toggle('active', mode === 'text');
  updateGenerateButton();
}

function updateGenerateButton() {
  const btn = document.getElementById('generateBtn');
  if (currentInputMode === 'file') {
    btn.disabled = uploadedFiles.length === 0;
  } else if (currentInputMode === 'url') {
    btn.disabled = urlFetchedTasks.length === 0;
  } else {
    btn.disabled = parsedTextTasks.length === 0;
  }
}

// ═══════════════════════════════════════════════════════════════════════════
// SMART TEXT PARSER
// ═══════════════════════════════════════════════════════════════════════════
const textInput = document.getElementById('textInput');
let parseDebounce = null;

textInput.addEventListener('input', () => {
  clearTimeout(parseDebounce);
  parseDebounce = setTimeout(parseTextInput, 400);
});

// Also handle paste events for immediate parsing
textInput.addEventListener('paste', () => {
  setTimeout(parseTextInput, 100);
});

function detectTextFormat(text) {
  const trimmed = text.trim();
  // JSON
  if (/^\s*[\[{]/.test(trimmed)) {
    try { JSON.parse(trimmed); return 'json'; } catch(e) {}
    // Try JSON lines
    const lines = trimmed.split('\n').filter(l => l.trim());
    if (lines.every(l => { try { JSON.parse(l); return true; } catch(e) { return false; } })) return 'json';
  }
  // CSV (contains commas, mostly structured)
  const lines = trimmed.split('\n').filter(l => l.trim());
  if (lines.length >= 2) {
    const commaCount = lines.map(l => (l.match(/,/g)||[]).length);
    const tabCount = lines.map(l => (l.match(/\t/g)||[]).length);
    const avgComma = commaCount.reduce((a,b)=>a+b,0)/lines.length;
    const avgTab = tabCount.reduce((a,b)=>a+b,0)/lines.length;
    // Consistent tab-separated
    if (avgTab >= 2 && tabCount.every(c => Math.abs(c - avgTab) <= 1)) return 'table';
    // Consistent comma-separated
    if (avgComma >= 2 && commaCount.every(c => Math.abs(c - avgComma) <= 1)) return 'csv';
    // Spaces with some structure (multiple whitespace separators)
    const spaceCount = lines.map(l => (l.match(/\s{2,}/g)||[]).length);
    const avgSpace = spaceCount.reduce((a,b)=>a+b,0)/lines.length;
    if (avgSpace >= 2 && spaceCount.every(c => Math.abs(c - avgSpace) <= 1)) return 'table';
  }
  return 'free';
}

function parseTextInput() {
  const text = textInput.value.trim();
  if (!text) {
    parsedTextTasks = [];
    hideParseStatus();
    updateFormatTags('');
    updateGenerateButton();
    return;
  }

  const fmt = detectTextFormat(text);
  updateFormatTags(fmt);

  try {
    let tasks = [];
    switch(fmt) {
      case 'json': tasks = parseJSONText(text); break;
      case 'csv': tasks = parseDelimitedText(text, /,/); break;
      case 'table': tasks = parseDelimitedText(text, /\t|\s{2,}/); break;
      case 'free': tasks = parseFreeText(text); break;
    }

    if (tasks.length > 0) {
      parsedTextTasks = tasks;
      showParseStatus('success', `成功解析 ${tasks.length} 条任务`);
    } else {
      parsedTextTasks = [];
      showParseStatus('error', '未能识别任务数据，请检查格式');
    }
  } catch(err) {
    parsedTextTasks = [];
    showParseStatus('error', '解析失败: ' + err.message);
  }
  updateGenerateButton();
}

function parseJSONText(text) {
  let data;
  try {
    data = JSON.parse(text);
  } catch(e) {
    // Try JSON lines
    const lines = text.split('\n').filter(l => l.trim());
    data = lines.map(l => JSON.parse(l));
  }
  if (!Array.isArray(data)) data = [data];

  return data.map((item, i) => {
    const normKeys = {};
    Object.keys(item).forEach(k => { normKeys[normalize(k)] = item[k]; });

    function findVal(keywords) {
      for (const kw of keywords) {
        const nk = normalize(kw);
        for (const [nkey, val] of Object.entries(normKeys)) {
          if (nkey === nk || nkey.includes(nk) || nk.includes(nkey)) return val;
        }
      }
      return null;
    }

    const name = findVal(FIELD_KEYWORDS.task_name) || findVal(['name','title','task']) || Object.values(item)[0];
    const start = parseDate(findVal(FIELD_KEYWORDS.start_date));
    const end = parseDate(findVal(FIELD_KEYWORDS.end_date));
    const owner = findVal(FIELD_KEYWORDS.owner) || '';
    const progress = parseProgress(findVal(FIELD_KEYWORDS.progress));
    const category = findVal(FIELD_KEYWORDS.category) || '默认';
    const id = findVal(FIELD_KEYWORDS.task_id) || `T${String(i+1).padStart(3,'0')}`;

    if (!name || (!start && !end)) return null;
    return {
      id: String(id), name: String(name).trim(),
      owner: String(owner).trim(),
      start: start || end, end: end || start,
      progress, priority: '', status: '',
      dependency: String(findVal(FIELD_KEYWORDS.dependency) || '').trim(),
      category: String(category).trim(),
      source: '文本解析'
    };
  }).filter(Boolean);
}

function parseDelimitedText(text, delimiter) {
  const lines = text.split('\n').filter(l => l.trim());
  if (lines.length < 2) return [];

  const rows = lines.map(l => l.split(delimiter).map(c => c.trim()));
  // Find header row (first row with 2+ non-empty cells)
  let headerIdx = 0;
  for (let i = 0; i < Math.min(rows.length, 5); i++) {
    if (rows[i].filter(c => c).length >= 2) { headerIdx = i; break; }
  }

  const headers = rows[headerIdx];
  const colMap = detectColumns(headers);

  if (colMap.task_name === undefined) {
    // Fallback: assume first column is name
    colMap.task_name = 0;
  }

  const get = (row, field) => {
    const idx = colMap[field];
    if (idx === undefined || idx >= row.length) return null;
    return row[idx];
  };

  const tasks = [];
  for (let r = headerIdx + 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.every(c => !c)) continue;
    const name = get(row, 'task_name');
    const start = parseDate(get(row, 'start_date'));
    const end = parseDate(get(row, 'end_date'));
    if (!name) continue;
    const finalStart = start || end || fmtDate(new Date());
    const finalEnd = end || start || fmtDate(ad(new Date(), 7));
    tasks.push({
      id: String(get(row, 'task_id') || `T${String(r).padStart(3,'0')}`),
      name: String(name).trim(),
      owner: String(get(row, 'owner') || '').trim(),
      start: finalStart, end: finalEnd,
      progress: parseProgress(get(row, 'progress')),
      priority: String(get(row, 'priority') || '').trim(),
      status: String(get(row, 'status') || '').trim(),
      dependency: String(get(row, 'dependency') || '').trim(),
      category: String(get(row, 'category') || '默认').trim(),
      source: '文本解析'
    });
  }
  return tasks;
}

function parseFreeText(text) {
  const lines = text.split('\n').filter(l => l.trim());
  const tasks = [];
  const dateRe = /(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g;
  const progressRe = /(\d{1,3})%/;

  lines.forEach((line, i) => {
    const trimmed = line.trim().replace(/^[-*•\d.)\]]+\s*/, '');
    if (!trimmed || trimmed.length < 2) return;

    // Extract dates
    const dates = [];
    let m;
    const dateRegex = /(\d{4}[-/]\d{1,2}[-/]\d{1,2})/g;
    while ((m = dateRegex.exec(trimmed)) !== null) {
      const d = parseDate(m[1]);
      if (d) dates.push(d);
    }

    // Extract progress
    const pm = progressRe.exec(trimmed);
    const progress = pm ? parseInt(pm[1]) : 0;

    // Extract owner - look for @mention or Chinese name patterns
    const ownerMatch = trimmed.match(/@(\S+)/) || trimmed.match(/负责[人:]?\s*(\S+)/);
    const owner = ownerMatch ? ownerMatch[1] : '';

    // Task name: remove extracted parts
    let name = trimmed
      .replace(dateRegex, '')
      .replace(progressRe, '')
      .replace(/@\S+/, '')
      .replace(/负责[人:]?\s*\S+/, '')
      .replace(/[~～\-—]+/g, ' ')
      .replace(/\s{2,}/g, ' ')
      .trim();

    if (!name || name.length < 2) return;

    const start = dates[0] || fmtDate(new Date());
    const end = dates[1] || dates[0] || fmtDate(ad(new Date(), 7));

    tasks.push({
      id: `T${String(i+1).padStart(3,'0')}`,
      name, owner,
      start, end,
      progress: Math.min(100, Math.max(0, progress)),
      priority: '', status: '', dependency: '',
      category: '默认', source: '文本解析'
    });
  });
  return tasks;
}

function updateFormatTags(fmt) {
  ['fmtTable','fmtCSV','fmtJSON','fmtFree'].forEach(id => {
    document.getElementById(id).classList.remove('detected');
  });
  if (fmt === 'table') document.getElementById('fmtTable').classList.add('detected');
  if (fmt === 'csv') document.getElementById('fmtCSV').classList.add('detected');
  if (fmt === 'json') document.getElementById('fmtJSON').classList.add('detected');
  if (fmt === 'free') document.getElementById('fmtFree').classList.add('detected');
}

function showParseStatus(type, msg) {
  const el = document.getElementById('parseStatus');
  el.className = 'parse-status active ' + type;
  el.querySelector('.status-icon').textContent = type === 'success' ? '\u2714' : '\u2718';
  el.querySelector('.status-msg').textContent = msg;
}
function hideParseStatus() {
  document.getElementById('parseStatus').className = 'parse-status';
}

function fillTemplate(type) {
  const templates = {
    table: `任务名称\t负责人\t开始日期\t结束日期\t进度\t分类
需求分析\t张三\t2025-03-01\t2025-03-15\t80%\t规划阶段
原型设计\t李四\t2025-03-10\t2025-03-20\t60%\t设计阶段
UI视觉设计\t王五\t2025-03-18\t2025-04-01\t30%\t设计阶段
前端开发\t赵六\t2025-04-01\t2025-04-30\t0%\t开发阶段
后端开发\t钱七\t2025-04-01\t2025-05-10\t0%\t开发阶段
集成测试\t孙八\t2025-05-10\t2025-05-25\t0%\t测试阶段
上线部署\t张三\t2025-05-25\t2025-05-30\t0%\t发布阶段`,

    csv: `任务名称,负责人,开始日期,结束日期,进度,分类
用户调研,产品组,2025-03-01,2025-03-10,100%,调研
竞品分析,产品组,2025-03-05,2025-03-15,90%,调研
功能规划,张明,2025-03-12,2025-03-22,50%,规划
架构设计,李工,2025-03-20,2025-04-05,20%,技术
数据库设计,王DBA,2025-03-25,2025-04-10,0%,技术
接口开发,后端组,2025-04-05,2025-05-01,0%,开发
页面开发,前端组,2025-04-10,2025-05-10,0%,开发
联调测试,测试组,2025-05-10,2025-05-25,0%,测试`,

    json: `[
  {"name": "项目启动", "owner": "项目经理", "start": "2025-03-01", "end": "2025-03-01", "progress": 100, "category": "里程碑"},
  {"name": "需求收集", "owner": "产品经理", "start": "2025-03-02", "end": "2025-03-15", "progress": 85, "category": "规划"},
  {"name": "技术选型", "owner": "架构师", "start": "2025-03-10", "end": "2025-03-18", "progress": 70, "category": "规划"},
  {"name": "MVP 开发", "owner": "开发团队", "start": "2025-03-18", "end": "2025-04-20", "progress": 30, "category": "开发"},
  {"name": "UI/UX 优化", "owner": "设计师", "start": "2025-04-01", "end": "2025-04-15", "progress": 10, "category": "设计"},
  {"name": "Alpha 测试", "owner": "QA", "start": "2025-04-20", "end": "2025-05-05", "progress": 0, "category": "测试"},
  {"name": "正式发布", "owner": "运维", "start": "2025-05-10", "end": "2025-05-10", "progress": 0, "category": "里程碑"}
]`,

    free: `需求分析 @张三 2025-03-01 2025-03-15 80%
原型设计 @李四 2025-03-10 2025-03-25 60%
UI设计 @王五 2025-03-20 2025-04-05 30%
前端开发 @赵六 2025-04-01 2025-04-30 0%
后端API开发 @钱七 2025-04-01 2025-05-10 10%
数据库优化 @孙八 2025-04-15 2025-05-01 0%
集成测试 @测试组 2025-05-10 2025-05-25 0%
上线发布 @运维组 2025-05-25 2025-05-30 0%`
  };

  textInput.value = templates[type] || '';
  parseTextInput();
}

// ═══════════════════════════════════════════════════════════════════════════
// DATA PREVIEW SYSTEM
// ═══════════════════════════════════════════════════════════════════════════
let previewTasks = [];
let previewSelected = new Set();
let previewColumnMapping = {};

function startPreview() {
  // Collect tasks based on current mode
  if (currentInputMode === 'file') {
    generateFromFiles().then(tasks => {
      if (tasks && tasks.length > 0) {
        openPreview(tasks);
      }
    });
  } else if (currentInputMode === 'url') {
    if (urlFetchedTasks.length > 0) {
      openPreview([...urlFetchedTasks]);
    }
  } else {
    if (parsedTextTasks.length > 0) {
      openPreview([...parsedTextTasks]);
    }
  }
}

async function generateFromFiles() {
  document.getElementById('loading').classList.add('active');
  try {
    let allTasks = [];
    for (let fi = 0; fi < uploadedFiles.length; fi++) {
      const file = uploadedFiles[fi];
      const prefix = `F${fi+1}_`;
      let rows;
      if (file.name.match(/\.csv$/i) || file.name.match(/\.tsv$/i)) {
        const text = await file.text();
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        rows = lines.map(l => l.split(/[,;\t]/).map(c => c.trim()));
      } else {
        const data = await file.arrayBuffer();
        const wb = XLSX.read(data, { type: 'array', cellDates: true });
        const ws = wb.Sheets[wb.SheetNames[0]];
        rows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: false, dateNF: 'yyyy-mm-dd' });
        const rawRows = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true });
        for (let r = 0; r < rows.length; r++) {
          for (let c = 0; c < (rows[r]||[]).length; c++) {
            const raw = rawRows[r]?.[c];
            if (typeof raw === 'number' && raw > 40000 && raw < 60000) {
              rows[r][c] = new Date((raw - 25569) * 86400000);
            }
          }
        }
      }
      const tasks = parseFileData(rows, file.name);
      const idMap = {};
      tasks.forEach(t => { idMap[t.id] = prefix + t.id; t.id = prefix + t.id; });
      tasks.forEach(t => {
        if (t.dependency) {
          t.dependency = t.dependency.split(/[,;、\s]+/).filter(Boolean).map(d => idMap[d] || d).join(',');
        }
      });
      allTasks = allTasks.concat(tasks);
    }
    if (allTasks.length === 0) { alert('未能从文件中解析出任何任务。请检查表格格式。'); return null; }
    return allTasks;
  } catch (err) {
    alert('解析失败: ' + err.message);
    console.error(err);
    return null;
  } finally {
    document.getElementById('loading').classList.remove('active');
  }
}

function openPreview(tasks) {
  previewTasks = tasks;
  previewSelected = new Set(tasks.map((_, i) => i));

  // Update workflow steps
  setWorkflowStep(2);

  // Stats
  const owners = new Set(tasks.map(t => t.owner).filter(Boolean));
  const cats = new Set(tasks.map(t => t.category));
  document.getElementById('previewStats').innerHTML = `
    <div class="preview-stat"><strong>${tasks.length}</strong> 条任务</div>
    <div class="preview-stat"><strong>${owners.size}</strong> 位负责人</div>
    <div class="preview-stat"><strong>${cats.size}</strong> 个分类</div>
  `;

  // Field mapping chips
  const fields = [
    { key: 'name', label: '任务名', essential: true },
    { key: 'start', label: '开始日期', essential: true },
    { key: 'end', label: '结束日期', essential: true },
    { key: 'owner', label: '负责人', essential: false },
    { key: 'progress', label: '进度', essential: false },
    { key: 'category', label: '分类', essential: false },
    { key: 'dependency', label: '依赖', essential: false }
  ];

  const bar = document.getElementById('fieldMappingBar');
  bar.innerHTML = '<label>字段映射：</label>';
  fields.forEach(f => {
    const hasData = tasks.some(t => t[f.key] && String(t[f.key]).trim());
    const cls = hasData ? 'field-chip mapped' : 'field-chip unmapped';
    bar.innerHTML += `<span class="${cls}"><span class="chip-dot"></span>${f.label}</span>`;
  });

  // Build table
  renderPreviewTable();

  document.getElementById('previewOverlay').classList.add('active');
}

function renderPreviewTable() {
  const tasks = previewTasks;
  const thead = document.getElementById('previewTHead');
  const tbody = document.getElementById('previewTBody');

  thead.innerHTML = `<tr>
    <th style="width:40px"><input type="checkbox" class="row-checkbox" onchange="toggleAllPreview(this)" checked></th>
    <th>ID</th>
    <th>任务名称</th>
    <th>负责人</th>
    <th>开始日期</th>
    <th>结束日期</th>
    <th>进度</th>
    <th>分类</th>
    <th>状态</th>
  </tr>`;

  tbody.innerHTML = tasks.map((t, i) => {
    const checked = previewSelected.has(i) ? 'checked' : '';
    const startOk = t.start && /^\d{4}-\d{2}-\d{2}$/.test(t.start);
    const endOk = t.end && /^\d{4}-\d{2}-\d{2}$/.test(t.end);
    const startCls = startOk ? 'cell-ok' : 'cell-error';
    const endCls = endOk ? 'cell-ok' : 'cell-error';

    return `<tr data-idx="${i}" style="opacity:${previewSelected.has(i)?1:0.4}">
      <td><input type="checkbox" class="row-checkbox" ${checked} onchange="togglePreviewRow(${i}, this)"></td>
      <td style="font-family:monospace;font-size:11px;color:var(--text-muted)">${t.id.replace(/^F\d+_/,'')}</td>
      <td><span class="cell-editable" contenteditable="true" data-field="name" data-idx="${i}" onblur="onPreviewCellEdit(this)">${escapeHtml(t.name)}</span></td>
      <td><span class="cell-editable" contenteditable="true" data-field="owner" data-idx="${i}" onblur="onPreviewCellEdit(this)">${escapeHtml(t.owner)}</span></td>
      <td class="${startCls}"><span class="cell-editable" contenteditable="true" data-field="start" data-idx="${i}" onblur="onPreviewCellEdit(this)">${t.start}</span></td>
      <td class="${endCls}"><span class="cell-editable" contenteditable="true" data-field="end" data-idx="${i}" onblur="onPreviewCellEdit(this)">${t.end}</span></td>
      <td style="text-align:center"><span class="cell-editable" contenteditable="true" data-field="progress" data-idx="${i}" onblur="onPreviewCellEdit(this)">${t.progress}%</span></td>
      <td><span class="cell-editable" contenteditable="true" data-field="category" data-idx="${i}" onblur="onPreviewCellEdit(this)">${escapeHtml(t.category)}</span></td>
      <td style="color:var(--text-muted)">${escapeHtml(t.status || '—')}</td>
    </tr>`;
  }).join('');

  updatePreviewCount();
}

function escapeHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function togglePreviewRow(idx, cb) {
  if (cb.checked) previewSelected.add(idx);
  else previewSelected.delete(idx);
  const row = cb.closest('tr');
  row.style.opacity = cb.checked ? 1 : 0.4;
  updatePreviewCount();
}

function toggleAllPreview(cb) {
  previewTasks.forEach((_, i) => {
    if (cb.checked) previewSelected.add(i);
    else previewSelected.delete(i);
  });
  renderPreviewTable();
}

function updatePreviewCount() {
  document.getElementById('previewSelectedCount').textContent = previewSelected.size;
}

function onPreviewCellEdit(el) {
  const idx = parseInt(el.dataset.idx);
  const field = el.dataset.field;
  let val = el.textContent.trim();
  if (field === 'progress') {
    val = parseInt(val.replace('%',''));
    if (isNaN(val)) val = 0;
    val = Math.min(100, Math.max(0, val));
    el.textContent = val + '%';
    previewTasks[idx].progress = val;
  } else if (field === 'start' || field === 'end') {
    const parsed = parseDate(val);
    if (parsed) {
      previewTasks[idx][field] = parsed;
      el.textContent = parsed;
      el.closest('td').className = 'cell-ok';
    } else {
      el.closest('td').className = 'cell-error';
    }
  } else {
    previewTasks[idx][field] = val;
  }
}

function closePreview() {
  document.getElementById('previewOverlay').classList.remove('active');
  setWorkflowStep(1);
}

function confirmAndGenerate() {
  const selectedTasks = previewTasks.filter((_, i) => previewSelected.has(i));
  if (selectedTasks.length === 0) { alert('请至少选择一条任务'); return; }

  // Validate dates
  const badDates = selectedTasks.filter(t => !t.start || !t.end || !/^\d{4}-\d{2}-\d{2}$/.test(t.start) || !/^\d{4}-\d{2}-\d{2}$/.test(t.end));
  if (badDates.length > 0) {
    if (!confirm(`有 ${badDates.length} 条任务的日期格式不完整，是否仍要继续？\n（缺失日期将使用默认值）`)) return;
    badDates.forEach(t => {
      if (!t.start || !/^\d{4}-\d{2}-\d{2}$/.test(t.start)) t.start = fmtDate(new Date());
      if (!t.end || !/^\d{4}-\d{2}-\d{2}$/.test(t.end)) t.end = fmtDate(ad(new Date(), 7));
    });
  }

  document.getElementById('previewOverlay').classList.remove('active');

  RAW_TASKS = selectedTasks;
  filteredTasks = [...selectedTasks];
  hasUnsavedChanges = false;
  updateUnsavedBadge();
  setWorkflowStep(3);
  showGanttScreen();
}

// ═══════════════════════════════════════════════════════════════════════════
// URL FETCH & WEB SCRAPING
// ═══════════════════════════════════════════════════════════════════════════
let urlFetchedTasks = [];
let urlFetchHistory = [];
let selectedFetchTableIdx = -1;
let lastFetchedTables = [];

const CORS_PROXIES = [
  url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
  url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
  url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
];

async function fetchUrl() {
  const input = document.getElementById('urlInput');
  let url = input.value.trim();
  if (!url) return;
  if (!/^https?:\/\//i.test(url)) url = 'https://' + url;

  const btn = document.getElementById('urlFetchBtn');
  btn.classList.add('loading');
  btn.disabled = true;

  // Add to history with loading state
  const historyIdx = urlFetchHistory.length;
  urlFetchHistory.push({ url, status: 'loading', count: 0 });
  renderUrlHistory();

  try {
    const html = await fetchWithProxy(url);
    const tables = extractTablesFromHtml(html, url);

    if (tables.length === 0) {
      urlFetchHistory[historyIdx].status = 'err';
      urlFetchHistory[historyIdx].msg = '未找到表格数据';
      renderUrlHistory();
      showFetchResult([], url);
    } else {
      urlFetchHistory[historyIdx].status = 'ok';
      urlFetchHistory[historyIdx].count = tables.reduce((a, t) => a + t.rows.length, 0);
      renderUrlHistory();
      lastFetchedTables = tables;
      showFetchResult(tables, url);
    }
  } catch (err) {
    console.error('Fetch error:', err);
    urlFetchHistory[historyIdx].status = 'err';
    urlFetchHistory[historyIdx].msg = err.message || '抓取失败';
    renderUrlHistory();
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

async function fetchWithProxy(url) {
  let lastErr;
  for (const proxyFn of CORS_PROXIES) {
    try {
      const proxyUrl = proxyFn(url);
      const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
      if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
      return await resp.text();
    } catch (e) {
      lastErr = e;
    }
  }
  throw new Error('所有代理均无法访问该网址: ' + (lastErr?.message || ''));
}

function extractTablesFromHtml(html, sourceUrl) {
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');
  const tables = doc.querySelectorAll('table');
  const results = [];

  tables.forEach((table, idx) => {
    const rows = [];
    const trs = table.querySelectorAll('tr');
    trs.forEach(tr => {
      const cells = [];
      tr.querySelectorAll('th, td').forEach(cell => {
        cells.push(cell.textContent.trim());
      });
      if (cells.some(c => c)) rows.push(cells);
    });

    if (rows.length >= 2) {
      // Try to detect if this looks like task data
      const headerRow = rows[0];
      const colMap = detectColumns(headerRow);
      const hasTaskFields = colMap.task_name !== undefined ||
        (colMap.start_date !== undefined && colMap.end_date !== undefined);

      let tableName = `表格 ${idx + 1}`;
      // Try to find a caption or preceding heading
      const caption = table.querySelector('caption');
      if (caption) tableName = caption.textContent.trim();

      results.push({
        name: tableName,
        headers: headerRow,
        rows: rows,
        dataRows: rows.length - 1,
        colMap,
        hasTaskFields,
        sourceUrl
      });
    }
  });

  // Sort: tables with task fields first
  results.sort((a, b) => (b.hasTaskFields ? 1 : 0) - (a.hasTaskFields ? 1 : 0));
  return results;
}

function showFetchResult(tables, url) {
  const box = document.getElementById('fetchResultBox');
  const container = document.getElementById('fetchResultTables');

  if (tables.length === 0) {
    box.classList.add('active');
    container.innerHTML = `<div style="font-size:12px;color:var(--text-muted);padding:8px;">
      未在页面中找到表格。你可以尝试切换到"智能解析"标签，手动粘贴数据。</div>`;
    return;
  }

  box.classList.add('active');
  container.innerHTML = tables.map((t, i) => {
    const match = t.hasTaskFields ? '<span style="color:var(--accent-green);font-size:10px;font-weight:600;">匹配度高</span>' : '';
    const cols = t.headers.slice(0, 5).join(', ') + (t.headers.length > 5 ? '...' : '');
    return `<div class="fetch-table-option ${i === 0 ? 'selected' : ''}" onclick="selectFetchTable(${i})">
      <input type="radio" name="fetchTable" ${i === 0 ? 'checked' : ''}>
      <div class="table-info">
        <div class="table-name">${t.name} ${match}</div>
        <div class="table-detail">${t.dataRows} 行数据 · 列: ${cols}</div>
      </div>
    </div>`;
  }).join('');

  // Auto-select best table
  selectFetchTable(0);
}

function selectFetchTable(idx) {
  selectedFetchTableIdx = idx;
  document.querySelectorAll('.fetch-table-option').forEach((el, i) => {
    el.classList.toggle('selected', i === idx);
    el.querySelector('input[type="radio"]').checked = (i === idx);
  });

  // Parse selected table into tasks
  const table = lastFetchedTables[idx];
  if (!table) return;

  const tasks = parseTableRows(table.rows, table.sourceUrl);
  urlFetchedTasks = tasks;
  updateGenerateButton();
}

function parseTableRows(rows, sourceUrl) {
  if (rows.length < 2) return [];
  const headers = rows[0];
  const colMap = detectColumns(headers);

  if (colMap.task_name === undefined) {
    // Fallback: find the column with longest text content
    let bestCol = 0, bestLen = 0;
    for (let c = 0; c < headers.length; c++) {
      const totalLen = rows.slice(1).reduce((a, r) => a + (r[c]||'').length, 0);
      if (totalLen > bestLen) { bestLen = totalLen; bestCol = c; }
    }
    colMap.task_name = bestCol;
  }

  const get = (row, field) => {
    const i = colMap[field];
    if (i === undefined || i >= row.length) return null;
    return row[i];
  };

  const hostname = (() => {
    try { return new URL(sourceUrl).hostname.replace(/^www\./, ''); } catch(e) { return 'web'; }
  })();

  const tasks = [];
  for (let r = 1; r < rows.length; r++) {
    const row = rows[r];
    if (!row || row.every(c => !c)) continue;
    const name = get(row, 'task_name');
    if (!name || !name.trim()) continue;

    const start = parseDate(get(row, 'start_date'));
    const end = parseDate(get(row, 'end_date'));
    const finalStart = start || end || fmtDate(new Date());
    const finalEnd = end || start || fmtDate(ad(new Date(), 7));

    tasks.push({
      id: String(get(row, 'task_id') || `W${String(r).padStart(3, '0')}`),
      name: String(name).trim(),
      owner: String(get(row, 'owner') || '').trim(),
      start: finalStart, end: finalEnd,
      progress: parseProgress(get(row, 'progress')),
      priority: String(get(row, 'priority') || '').trim(),
      status: String(get(row, 'status') || '').trim(),
      dependency: String(get(row, 'dependency') || '').trim(),
      category: String(get(row, 'category') || '默认').trim(),
      source: hostname
    });
  }
  return tasks;
}

function renderUrlHistory() {
  const container = document.getElementById('urlHistory');
  container.innerHTML = urlFetchHistory.map((h, i) => {
    const statusCls = h.status === 'ok' ? 'ok' : h.status === 'err' ? 'err' : 'loading';
    const info = h.status === 'ok' ? `<span class="url-count">${h.count} 行</span>` :
      h.status === 'err' ? `<span style="font-size:10px;color:var(--accent-red)">${h.msg||'失败'}</span>` :
        '<span style="font-size:10px;color:var(--accent-orange)">抓取中...</span>';
    return `<div class="url-history-item" onclick="reuseUrl(${i})">
      <div class="url-status-dot ${statusCls}"></div>
      <div class="url-text" title="${h.url}">${h.url}</div>
      ${info}
      <button class="url-remove" onclick="event.stopPropagation();removeUrlHistory(${i})">×</button>
    </div>`;
  }).join('');
}

function reuseUrl(idx) {
  document.getElementById('urlInput').value = urlFetchHistory[idx].url;
}

function removeUrlHistory(idx) {
  urlFetchHistory.splice(idx, 1);
  renderUrlHistory();
}

// ═══════════════════════════════════════════════════════════════════════════
// WORKFLOW STEP INDICATOR
// ═══════════════════════════════════════════════════════════════════════════
function setWorkflowStep(step) {
  ['wfStep1','wfStep2','wfStep3'].forEach((id, i) => {
    const el = document.getElementById(id);
    el.classList.remove('active','done');
    if (i + 1 < step) el.classList.add('done');
    if (i + 1 === step) el.classList.add('active');
  });
  ['wfConn1','wfConn2'].forEach((id, i) => {
    const el = document.getElementById(id);
    el.classList.toggle('done', i + 1 < step);
  });
}
</script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/v67327c56f0bb4ef8b305cae61679db8f1769101564043" integrity="sha512-rdcWY47ByXd76cbCFzznIcEaCN71jqkWBBqlwhF1SY7KubdLKZiEGeP7AyieKZlGP9hbY/MhGrwXzJC/HulNyg==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/v67327c56f0bb4ef8b305cae61679db8f1769101564043" integrity="sha512-rdcWY47ByXd76cbCFzznIcEaCN71jqkWBBqlwhF1SY7KubdLKZiEGeP7AyieKZlGP9hbY/MhGrwXzJC/HulNyg==" data-cf-beacon='{"version":"2024.11.0","token":"75124c326cb447fe934cde04713ae013","r":1,"server_timing":{"name":{"cfCacheStatus":true,"cfEdge":true,"cfExtPri":true,"cfL4":true,"cfOrigin":true,"cfSpeedBrain":true},"location_startswith":null}}' crossorigin="anonymous"></script>
</body>
</html>
